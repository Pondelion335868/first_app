var MailLock=Class.create();Object.extend(MailLock.prototype,{elProgressOn:null,elProgressOff:null,locked:false,initialize:function(idProgressOn,idProgressOff){this.elProgressOn=$(idProgressOn);this.elProgressOff=$(idProgressOff);},get:function(){if(this.locked){return false;}
this.locked=true;if(this.elProgressOn!=null)Element.show(this.elProgressOn);if(this.elProgressOff!=null)Element.hide(this.elProgressOff);if(mailSearch!=null)mailSearch.lock();if(mailFolder!=null)mailFolder.lock();if(mailList!=null)mailList.lock();if(mailControl!=null)mailControl.lock();if(mailViewer!=null)mailViewer.lock();return true;},release:function(){if(mailSearch!=null)mailSearch.unlock();if(mailFolder!=null)mailFolder.unlock();if(mailList!=null)mailList.unlock();if(mailControl!=null)mailControl.unlock();if(mailViewer!=null)mailViewer.unlock();if(this.elProgressOn!=null)Element.hide(this.elProgressOn);if(this.elProgressOff!=null)Element.show(this.elProgressOff);this.locked=false;}});var MailRequest=Class.create();Object.extend(MailRequest.prototype,{onSuccessFunc:null,onFailureFunc:null,initialize:function(){},setDefaultParameter:function(param){return param;},request:function(action,param,onSuccess,onFailure){if(!mailLock.get()){return false;}
this.onSuccessFunc=onSuccess;this.onFailureFunc=onFailure;var uri=amdata.url.bin+"ammain/"+action;param.id=amdata.session.ID;param.actid=action;param.ajax="on";param=this.setDefaultParameter(param);var option={};option.method="post";option.parameters=$H(param).toQueryString();option.asynchronous=true;option.onSuccess=this.onSuccess.bind(this);option.onFailure=this.onFailure.bind(this);this.send(uri,option);return true;},send:function(uri,option){var req=new Ajax.Request(uri,option);},onSuccess:function(request,header){(this.onSuccessFunc||Prototype.emptyFunction)(request,header);mailLock.release();},onFailure:function(request,header){ammsg.error("RMAIL0270");(this.onFailureFunc||Prototype.emptyFunction)(request,header);mailLock.release();}});var MailCommonRequest=Class.create();Object.extend(MailCommonRequest.prototype,MailRequest.prototype);Object.extend(MailCommonRequest.prototype,{elUpdater:null,composeDelay:1,onCompleteFunc:null,initialize:function(idUpdater){this.elUpdater=$(idUpdater);},send:function(uri,option){option.evalScripts=true;var req=new Ajax.Updater(this.elUpdater,uri,option);},onSuccess:function(request,header){mailLock.release();},mailsToParam:function(mails){var param={};var len=mails.length;for(var i=0;i<len;i++){param["f"+i]=mails[i].folder;param["u"+i]=mails[i].uid;}
return param;},moveMail:function(mails,folder,onSuccess,onFailure){var param=this.mailsToParam(mails);param.folder=folder;mailList.saveScrollTop();mailList.saveSelectRowIndexes();mailList.saveFocusIndex();return this.request("rmail_move_mail",param,onSuccess,onFailure);},copyMail:function(mails,folder,onSuccess,onFailure){var param=this.mailsToParam(mails);param.folder=folder;mailList.saveScrollTop();mailList.saveSelectRowUids();mailList.saveFocusUid();return this.request("rmail_copy_mail",param,onSuccess,onFailure);},moveSpam:function(mails,onSuccess,onFailure){if(Object.evalAmBoolean(amdata.sys.DISP_JUNKMAIL))
{var param=this.mailsToParam(mails);mailList.saveScrollTop();mailList.saveSelectRowIndexes();mailList.saveFocusIndex();return this.request("rmail_move_spam",param,onSuccess,onFailure);}},moveTrash:function(mails,onSuccess,onFailure){var param=this.mailsToParam(mails);mailList.saveScrollTop();mailList.saveSelectRowIndexes();mailList.saveFocusIndex();return this.request("rmail_move_trash",param,onSuccess,onFailure);},deleteMail:function(mails,onSuccess,onFailure,alreadySave){var param=this.mailsToParam(mails);if(!alreadySave){mailList.saveScrollTop();mailList.saveSelectRowIndexes();mailList.saveFocusIndex();}
return this.request("rmail_delete_mail",param,onSuccess,onFailure);},setSeen:function(mails,onSuccess,onFailure){var param=this.mailsToParam(mails);mailList.saveScrollTop();mailList.saveSelectRowUids();mailList.saveFocusUid();return this.request("rmail_setseen",param,onSuccess,onFailure);},setUnseen:function(mails,onSuccess,onFailure){var param=this.mailsToParam(mails);mailList.saveScrollTop();mailList.saveSelectRowUids();mailList.saveFocusUid();return this.request("rmail_setunseen",param,onSuccess,onFailure);},setFlag:function(mails,onSuccess,onFailure){var param=this.mailsToParam(mails);mailList.saveScrollTop();mailList.saveSelectRowUids();mailList.saveFocusUid();return this.request("rmail_setflag",param,onSuccess,onFailure);},unsetFlag:function(mails,onSuccess,onFailure){var param=this.mailsToParam(mails);mailList.saveScrollTop();mailList.saveSelectRowUids();mailList.saveFocusUid();return this.request("rmail_unsetflag",param,onSuccess,onFailure);},getPop:function(onSuccess,onFailure){var param={};return this.request("rmail_getpop",param,onSuccess,onFailure);},getTrashInfo:function(onSuccess,onFailure){var param={};return this.request("rmail_trashstatus",param,onSuccess,onFailure);},clearTrash:function(onSuccess,onFailure){var param={};return this.request("rmail_cleartrash",param,onSuccess,onFailure);},sendMdn:function(folder,uid,recipient,onSuccess,onFailure){var param={folder:folder,uid:uid,recipient:recipient};return this.request("rmail_sendmdn",param,onSuccess,onFailure);},onComplete:function(status,refreshList,param){status=parseInt(status);(this.onSuccessFunc||Prototype.emptyFunction)(status,param);if(refreshList){if(mailSearch.isOnDetailSearch()){mailControl.setReqFirst(true);}
mailList.loadList(false);}},compose:function(action,param,onComplete){if(!mailLock.get()){return false;}
this.onCompleteFunc=onComplete;amtop.openSmail(action,param);this.onCompleteCompose.bind(this).delay(this.composeDelay);return true;},onCompleteCompose:function(){(this.onCompleteFunc||Prototype.emptyFunction)();mailLock.release();},composeForward:function(mails,onComplete){var action;if(mails.length>1){action="create_multiatt_forward";}else{action="create_forward";}
var param=this.mailsToParam(mails);return this.compose(action,param,onComplete);},composeForwardRef:function(mails,onComplete){if(mails.length>1){mails.length=1;}
var param=this.mailsToParam(mails);return this.compose("create_ref_forward",param,onComplete);},composeForwardAtt:function(mails,onComplete){var action;if(mails.length>1){action="create_multiatt_forward";}else{action="create_att_forward";}
var param=this.mailsToParam(mails);return this.compose(action,param,onComplete);},composeReply:function(mails,onComplete){if(mails.length>1){mails.length=1;}
var param=this.mailsToParam(mails);return this.compose("create_reply",param,onComplete);},composeReplyAll:function(mails,onComplete){if(mails.length>1){mails.length=1;}
var param=this.mailsToParam(mails);return this.compose("create_all_reply",param,onComplete);},composeReEdit:function(mails,onComplete){if(mails.length>1){mails.length=1;}
var param=this.mailsToParam(mails);return this.compose("create_draft",param,onComplete);}});var MailFolderRequest=Class.create(MailRequest,{elUpdater:null,initialize:function(idUpdater){this.elUpdater=$(idUpdater);},setDefaultParameter:function(param){if(Object.evalAmBoolean(amdata.sys.ENABLE_DISPLAYUNSEEN,amdata.usr.DISPLAY_UNSEEN)){param.unseen="on";}
return param;},request:function($super,action,param,onSuccess,onFailure){if($super(action,param,onSuccess,onFailure)){amtop.tabController.lock('rmail');return true;}else{return false;}},onSuccess:function(request,header){var xml,status,folder;try{xml=request.responseXML;var amdata=amtop.XMLUtil.getAmData(xml);status=parseInt(amdata.statusCode);folder=amdata.targetFolder;}catch(e){Element.update(this.elUpdater,request.responseText);(this.onFailureFunc||Prototype.emptyFunction)(0,request,header);mailLock.release();return;}
amtop.replaceMailFolderCache(xml);if(status>=0){(this.onSuccessFunc||Prototype.emptyFunction)(status,xml,folder);}else{(this.onFailureFunc||Prototype.emptyFunction)(status,request,header);}
mailLock.release();amtop.tabController.unlock('rmail');if(is.safari){mailControl.pulldown.rebuild();}},onFailure:function(request,header){ammsg.error("RMAIL0270");(this.onFailureFunc||Prototype.emptyFunction)(0,request,header);mailLock.release();amtop.tabController.unlock('rmail');},refreshFolder:function(onSuccess,onFailure){return this.request("top_mailfolder",{},onSuccess,onFailure);},renameFolder:function(hash,name,onSuccess,onFailure){var param={folder:hash,new_name:name};return this.request("rmail_rename_folder",param,onSuccess,onFailure);},moveFolder:function(tgtHash,dstHash,onSuccess,onFailure){var param={tgt_folder:tgtHash,dst_folder:dstHash};return this.request("rmail_move_folder",param,onSuccess,onFailure);},createFolder:function(parentHash,name,onSuccess,onFailure){var param={current_folder:mailFolder.getCurrentFolder(true),parent:parentHash,new_name:name};return this.request("rmail_create_folder",param,onSuccess,onFailure);},deleteFolder:function(hash,onSuccess,onFailure){var param={folder:hash};return this.request("rmail_delete_folder",param,onSuccess,onFailure);}});var MailListRequest=Class.create();Object.extend(MailListRequest.prototype,MailRequest.prototype);Object.extend(MailListRequest.prototype,{elUpdater:null,initialize:function(idUpdater){this.elUpdater=$(idUpdater);},setDefaultParameter:function(param){param.page=mailList.getCurrentPage();param.page_size=mailList.getPageSize();var condition=mailList.getSortCondition();param.sort_primary=condition[0];param.sort_secondary=condition[1];param.filter_tgt=mailControl.getFilterCondition();if(param.filter_tgt){param.filter_mode="on";}else{param.filter_mode="off";}
if(mailSearch.isOnSearch()){param.search_mode="on";param.s_keyword=mailSearch.getKeyword();param.s_detail=Object.toAmBoolean(mailSearch.isOnDetailSearch());param.stgt_sender=Object.toAmBoolean(mailSearch.isCheckSender());param.stgt_subject=Object.toAmBoolean(mailSearch.isCheckSubject());param.stgt_recipient=Object.toAmBoolean(mailSearch.isCheckRecipient());param.stgt_content=Object.toAmBoolean(mailSearch.isCheckContent());param.s_date=mailSearch.getDate();param.s_date_range=mailSearch.getDateRange();param.s_allfolder=Object.toAmBoolean(mailSearch.isCheckAllFolder());param.s_hierarchy=Object.toAmBoolean(mailSearch.isCheckHierarchy());}else{param.search_mode="off";}
return param;},_getUnseenUpdate:function(doc){var obj={};var tmp=doc.getElementsByTagName("unseenupdate");if(tmp.length<1){return null;}
var fl=tmp[0].getElementsByTagName("folder");if(fl.length<1){return null;}
for(var i=0;i<fl.length;i++){var hash=fl[i].getElementsByTagName("hash")[0];var unseen=fl[i].getElementsByTagName("unseen")[0];obj[hash.firstChild.data]={unseen:unseen.firstChild.data};}
return obj;},onSuccess:function(request,obj){var xml,status,total,unseen,realUnseen,size,current,max,result,sort,refreshFolder,popNumber,popResult;try{xml=request.responseXML;var amdata=amtop.XMLUtil.getAmData(xml);status=parseInt(amdata.statusCode);total=parseInt(amdata.mailTotalNum);unseen=parseInt(amdata.mailUnseenNum);realUnseen=parseInt(amdata.mailRealUnseenNum);size=amdata.folderSize;current=parseInt(amdata.pageCurrent);max=parseInt(amdata.pageMax);result=parseInt(amdata.searchResult);sort=amdata.sortCondition;refreshFolder=parseInt(amdata.refreshFolder);popNumber=amdata.popReceivedNumber;popResult=amdata.popReceiveResult;adminPopNumber=amdata.adminPopReceivedNumber;adminPopResult=amdata.adminPopReceiveResult;unseenUpdate=this._getUnseenUpdate(xml);}catch(e){Element.update(this.elUpdater,request.responseText);(this.onFailureFunc||Prototype.emptyFunction)(0,request);mailLock.release();return;}
if(status>=0){(this.onSuccessFunc||Prototype.emptyFunction)(status,xml,total,unseen,realUnseen,size,current,max,result,sort,refreshFolder,popNumber,popResult,adminPopNumber,adminPopResult,unseenUpdate);}else{(this.onFailureFunc||Prototype.emptyFunction)(status,request);}
mailLock.release();},onFailure:function(request,obj){ammsg.error("RMAIL0270");(this.onFailureFunc||Prototype.emptyFunction)(0,request);mailLock.release();},loadList:function(folder,onSuccess,onFailure){var param={folder:folder,reqfirst:Object.toAmBoolean(mailControl.getReqFirst())};return this.request("rmail_maillist",param,onSuccess,onFailure);},furiwake:function(folder,onSuccess,onFailure){var param={folder:folder,reqfirst:"on",furiwake:"on"};mailControl.setReqFirst(false);return this.request("rmail_maillist",param,onSuccess,onFailure);}});var MailViewRequest=Class.create();Object.extend(MailViewRequest.prototype,MailRequest.prototype);Object.extend(MailViewRequest.prototype,{popupDelay:1,windowOption:"scrollbars=yes,menubar=no,toolbar=no,location=no,width=740,height=500,resizable=yes",setDefaultParameter:function(param){param.expand_header=Object.toAmBoolean(mailViewer.isHeaderExpanded());param.prev=Object.toAmBoolean(mailList.isEnablePrevious());param.next=Object.toAmBoolean(mailList.isEnableNext());param.menu="on";param.detail_search=Object.toAmBoolean(mailSearch.isOnDetailSearch());return param;},send:function(uri,option){new Ajax.LiteRequest(uri,option);},readMail:function(folder,uid,onSuccess,onFailure){var param={folder:folder,uid:uid,subject_width:0};return this.request("rmail_readmail",param,onSuccess,onFailure);},onSuccess:function(request,header){mailViewer.update(request.responseText);(this.onSuccessFunc||Prototype.emptyFunction)(request,header);mailLock.release();},onFailure:function(request,header){mailViewer.close();ammsg.error("RMAIL0270");(this.onFailureFunc||Prototype.emptyFunction)(request,header);mailLock.release();},popup:function(param){mailLock.get();if(!param){param={};}
param.id=amdata.session.ID;if(mailSearch){param.detail_search=Object.toAmBoolean(mailSearch.isOnDetailSearch());}
var uri=amdata.url.bin+"ammain/"+param.actid+"?"+$H(param).toQueryString();window.open(uri,"",this.windowOption);this.onCompletePopup.bind(this).delay(this.popupDelay);return true;},onCompletePopup:function(){mailLock.release();},popupReadMailFromShortcut:function(folder,uid){var param={actid:"rmail_popup_mail",folder:folder,uid:uid,popup:"on",shortcut:"on",expand_header:Object.toAmBoolean(mailViewer.isHeaderExpanded()),subject_width:0};return this.popup(param);},popupReadMail:function(folder,uid){var param={actid:"rmail_popup_mail",folder:folder,uid:uid,popup:"on",expand_header:Object.toAmBoolean(mailViewer.isHeaderExpanded()),subject_width:0};return this.popup(param);},popupPrintMail:function(folder,uid){var param={actid:"rmail_print_mail",print:"on",folder:folder,uid:uid,expand_header:"on",expand_addresses:"on",subject_width:0,with_image:1};return this.popup(param);},popupHtmlMail:function(folder,uid,part){var param={actid:"rmail_read_html",folder:folder,uid:uid,part:part||""};return this.popup(param);},popupTextMail:function(folder,uid,part){var param={actid:"rmail_read_plaintext",folder:folder,uid:uid,part:part||""};return this.popup(param);},popupMailSource:function(folder,uid){var param={actid:"rmail_read_source",folder:folder,uid:uid};return this.popup(param);},withImageHtmlMail:function(folder,uid,onSuccess,onFailure){var param={folder:folder,uid:uid,subject_width:0,with_image:1};return this.request("rmail_readmail",param,onSuccess,onFailure);},popupAmSystemMdn:function(folder,uid){var param={actid:"rmail_amsystem_mdn",folder:folder,uid:uid};return this.popup(param);}});var InputTextBox=Class.create();Object.extend(InputTextBox.prototype,{el:null,initText:"",onEnterFunc:null,edited:false,NO_ERROR:0,ERR_INIT:1,ERR_EMPTY:2,ERR_ALLSPACE:3,initialize:function(id,text,onEnter){this.el=$(id);this.el.value=text;this.initText=text;this.onEnterFunc=onEnter;Event.observe(this.el,"focus",this.onFocus.bind(this));Event.observe(this.el,"keypress",this.onKeyPress.bindAsEventListener(this));},onFocus:function(){if(!this.edited){this.el.value="";this.edited=true;}},onKeyPress:function(ev){if(ev.keyCode==Event.KEY_RETURN){Event.stop(ev);(this.onEnterFunc||Prototype.emptyFunction)(this);}},check:function(){var value=this.el.value;if(!this.edited&&(value==this.initText)){return this.ERR_INIT;}
if(value==""){return this.ERR_EMPTY;}
value=value.wstrip();if(value==""){return this.ERR_ALLSPACE;}
this.el.value=value.spacize();return this.NO_ERROR;},getValue:function(){if(!this.edited&&(this.el.value==this.initText)){return"";}else{return this.el.value;}},setValue:function(value){this.el.value=value;this.edited=true;},reset:function(){this.edited=false;this.el.value=this.initText;}});var MailSearch=Class.create();Object.extend(MailSearch.prototype,{itbKeyword:null,itbDate:null,elSearch:null,elOpenDetail:null,elCloseDetail:null,elCheckSender:null,elCheckRecipient:null,elCheckSubject:null,elCheckContent:null,elDateRange:null,elFolderSelected:null,elFolderHierarchy:null,elFolderAll:null,elAreaDetail:null,elAreaSearch:null,elAreaFolder:null,onSearch:false,onDetailSearch:false,onMultiSearch:false,onAllSearch:false,modeDetail:false,currentCondition:null,locked:false,initialize:function(args){this.itbKeyword=new InputTextBox(args.idKeyword,args.txtInitKeyword,this.search.bind(this));this.itbDate=new InputTextBox(args.idDate,args.txtInitDate);this.elSearch=$(args.idSearch);Event.observe(this.elSearch,"click",this.search.bind(this));if(Object.evalAmBoolean(amdata.sys.ENABLE_DETAIL_SEARCH)){this.elOpenDetail=$(args.idOpenDetail);this.elCloseDetail=$(args.idCloseDetail);Event.observe(this.elOpenDetail,"click",this.openDetail.bind(this));Event.observe(this.elCloseDetail,"click",this.closeDetail.bind(this));}
this.elCheckSender=$(args.idCheckSender);this.elCheckRecipient=$(args.idCheckRecipient);this.elCheckSubject=$(args.idCheckSubject);this.elCheckContent=$(args.idCheckContent);Event.observe(this.elCheckContent,"click",this.onClickCheckContent.bind(this));this.elDateRange=$(args.idDateRange);this.elFolderSelected=$(args.idFolderSelected);Event.observe(this.elFolderSelected,"click",this.onClickFolderSelected.bind(this));this.elFolderHierarchy=$(args.idFolderHierarchy);this.elFolderAll=$(args.idFolderAll);Event.observe(this.elFolderAll,"click",this.onClickFolderAll.bind(this));this.elAreaDetail=$(args.idAreaDetail);this.elAreaSearch=$(args.idAreaSearch);this.elAreaFolder=$(args.idAreaFolder);Event.observe(args.idResetSearch,"click",this.reset.bind(this));this.initCondition();},lock:function(){this.elSearch.disabled=true;this.locked=true;},unlock:function(){this.elSearch.disabled=false;this.locked=false;},makeFullDate:function(date){if(date&&((date.length==4)||(date.length==6))){var year=(new Date()).getYear();if(year<1900){year+=1900;}
year=year.toString();if(date.length==4){date=year+date;}else if(date.length==6){date=year.substr(0,2)+date;}}
return date;},checkCondition:function(){var resultKeyword=this.itbKeyword.check();if(!this.modeDetail){if((resultKeyword==this.itbKeyword.ERR_INIT)||(resultKeyword==this.itbKeyword.ERR_EMPTY)){ammsg.error("RMAIL0020");return false;}
if(resultKeyword==this.itbKeyword.ERR_ALLSPACE){ammsg.error("RMAIL0030");return false;}}else{var resultDate=this.itbDate.check();if((resultKeyword==this.itbKeyword.ERR_INIT)||(resultKeyword==this.itbKeyword.ERR_EMPTY)){if((resultDate==this.itbDate.ERR_INIT)||(resultDate==this.itbDate.ERR_EMPTY)){ammsg.error("RMAIL0020");return false;}}else{if(!(this.elCheckSender.checked||this.elCheckRecipient.checked||this.elCheckSubject.checked||this.elCheckContent.checked)){ammsg.warn("RMAIL0010");return false;}}
if(resultKeyword==this.itbKeyword.ERR_ALLSPACE){ammsg.error("RMAIL0030");return false;}
var dateValue=this.itbDate.getValue();if(dateValue){dateValue=this.makeFullDate(dateValue);if(!Date.validate(dateValue)){ammsg.error("RMAIL0330");return false;}}}
return true;},setCondition:function(){if(this.currentCondition){delete this.currentCondition;}
this.currentCondition={};this.currentCondition.keyword=this.itbKeyword.getValue();this.currentCondition.onDetail=this.modeDetail;this.currentCondition.bySender=this.elCheckSender.checked;this.currentCondition.byRecipient=this.elCheckRecipient.checked;this.currentCondition.bySubject=this.elCheckSubject.checked;this.currentCondition.byContent=this.elCheckContent.checked;this.currentCondition.date=this.makeFullDate(this.itbDate.getValue());this.currentCondition.dateRange=this.elDateRange.value;this.currentCondition.allFolder=this.elFolderAll.checked;this.currentCondition.hierarchy=this.elFolderHierarchy.checked;},setSearch:function(){if(!this.checkCondition()){return false;}
this.setCondition();this.onSearch=true;if(this.currentCondition.onDetail){this.onDetailSearch=true;}else{this.onDetailSearch=false;}
if(this.currentCondition.allFolder||this.currentCondition.hierarchy){this.onMultiSearch=true;}else{this.onMultiSearch=false;}
if(this.currentCondition.allFolder){this.onAllSearch=true;mailFolder.allSearchOn();}else{this.onAllSearch=false;mailFolder.allSearchOff();}
mailList.searchOn();mailControl.searchOn();return true;},cancelSearch:function(){if(Object.evalAmBoolean(amdata.sys.ENABLE_DETAIL_SEARCH)){this.closeDetail();}
this.itbKeyword.reset();this.itbDate.reset();this.setCondition();mailFolder.allSearchOff();mailList.searchOff();mailControl.searchOff();this.onSearch=false;this.onDetailSearch=false;this.onMultiSearch=false;this.onAllSearch=false;},search:function(){if(this.locked)return;if(!this.setSearch()){return;}
mailControl.setReqFirst(true);mailList.loadList(true,this.onCompleteSearch.bind(this));},reset:function(){if(this.locked)return;this.cancelSearch();mailControl.setReqFirst(true);mailList.loadList(true,this.onCompleteSearch.bind(this));},onCompleteSearch:function(){mailControl.changeStatus();},openDetail:function(){this.modeDetail=true;this.elOpenDetail.hide();this.elCloseDetail.show();this.elAreaDetail.show();mailLayout.fit('folder');},closeDetail:function(){this.modeDetail=false;this.elOpenDetail.show();this.elCloseDetail.hide();this.elAreaDetail.hide();mailLayout.fit('folder');this.initCondition();if(calendar.isOpen){calendar.display();}},initCondition:function(){this.elCheckSender.checked=true;this.elCheckSender.disabled=false;this.elCheckRecipient.checked=true;this.elCheckRecipient.disabled=false;this.elCheckSubject.checked=true;this.elCheckSubject.disabled=false;this.elCheckContent.checked=false;this.itbDate.reset();this.elDateRange.selectedIndex=0;this.elFolderSelected.checked=true;this.elFolderHierarchy.checked=false;this.elFolderHierarchy.disabled=false;this.elFolderAll.checked=false;},onClickCheckContent:function(){if(this.elCheckContent.checked){this.elCheckSender.disabled=true;this.elCheckRecipient.disabled=true;this.elCheckSubject.disabled=true;}else{this.elCheckSender.disabled=false;this.elCheckRecipient.disabled=false;this.elCheckSubject.disabled=false;}},onClickFolderSelected:function(){this.elFolderHierarchy.disabled=false;},onClickFolderAll:function(){this.elFolderHierarchy.disabled=true;},getKeyword:function(){return this.currentCondition.keyword;},isOnSearch:function(){return this.onSearch;},isOnDetailSearch:function(){return this.onDetailSearch;},isOnMultiSearch:function(){return this.onMultiSearch;},isOnAllSearch:function(){return this.onAllSearch;},isCheckSender:function(){return this.currentCondition.bySender;},isCheckSubject:function(){return this.currentCondition.bySubject;},isCheckRecipient:function(){return this.currentCondition.byRecipient;},isCheckContent:function(){return this.currentCondition.byContent;},getDate:function(){return this.currentCondition.date;},getDateRange:function(){return this.currentCondition.dateRange;},isCheckAllFolder:function(){return this.currentCondition.allFolder;},isCheckHierarchy:function(){return this.currentCondition.hierarchy;}});var MailFolder=Class.create();Object.extend(MailFolder.prototype,{elCreateButton:null,elDeleteButton:null,elUnseenButton:null,formTitle:null,formSource:null,folder:null,currentID:0,currentHash:"",previousName:"",onEdit:false,onDragProcessing:false,onDragging:false,treeReady:false,initialize:function(args){this.elCreateButton=$(args.idCreateButton);if(this.elCreateButton){this.elCreateButton.observe("click",this.displayCreateFolderForm.bind(this));}
this.elDeleteButton=$(args.idDeleteButton);if(this.elDeleteButton){this.elDeleteButton.observe("click",this.confirmDeleteFolder.bind(this));}
this.elUnseenButton=$(args.idUnseenButton);if(this.elUnseenButton){this.elUnseenButton.observe("click",this.updateFolderUnseen.bind(this));}
this.formTitle=args.formTitle;this.formSource=args.formSource;this.mouseInCounter={};var param={fDiv:args.idFolderArea,fOption:{AutoTooltip:true,Highlight:true,TreeLine:true,Edit:true,EditMaxLength:50,DragAndDrop:true,SmartParsing:true,ExContainer:args.idFolderContainer},fHandler:{OpenEnd:this.onOpenFolder.bind(this),Click:this.onSelectFolder.bind(this),Edit:this.onEditFolder.bind(this),BeforeDrag:this.onBeforeDrag.bind(this),NodeToDrag:this.onCreateDragNode.bind(this),Drag:this.onDragAndDrop.bind(this),DragEnd:this.onDragEnd.bind(this),MouseIn:this.onMouseIn.bind(this),MouseOut:this.onMouseOut.bind(this),XLE:this.onXLE.bind(this)}};this.folder=new am.XTree(param);if(args.contextMenu){args.contextMenu.tree=this.folder;args.contextMenu.setting={scroll:"hide",scroll_parent:$(args.idFolderContainer),leveling:true};this.contextMenu=new RmailTreeContextMenu(args.contextMenu);this.contextMenu.setItemHandler("createFolder",this.displayCreateFolderForm_callContextMenu.bind(this));this.contextMenu.setItemHandler("deleteFolder",this.confirmDeleteFolder_callContextMenu.bind(this));}},_openFolder:function(id){if(!this.folder.getOpenState(id)&&this.folder.getChildCount(id)){this.folder.open(id);}
this.onMouseOut(id);},onMouseIn:function(id){if(!this.onDragging&&!mailList.onDragging){return;}
if(!this.mouseInCounter[id]){this.mouseInCounter[id]=new TimeoutCounter({interval:100,limit:5,onTimeout:this._openFolder.bind(this,id)});this.mouseInCounter[id].start();}},onMouseOut:function(id){if(this.mouseInCounter[id]){delete(this.mouseInCounter[id].onTimeout);this.mouseInCounter[id].destroy();delete(this.mouseInCounter[id]);}},lock:function(){if(this.elCreateButton){this.elCreateButton.disabled=true;}
if(this.elDeleteButton){this.elDeleteButton.disabled=true;}
if(this.elUnseenButton){this.elUnseenButton.disabled=true;}
this.folder.enableItemSelect(false);this.folder.enableItemEditor(false);this.folder.enableDragAndDrop(false);},unlock:function(){var edit=this.folder.getDataById(this.currentID,"EDIT");if(this.elCreateButton&&!this.isSharedFolder(this.currentID)){this.elCreateButton.disabled=false;}
if(this.elDeleteButton&&Object.evalAmBoolean(edit)){this.elDeleteButton.disabled=false;}
if(this.elUnseenButton){this.elUnseenButton.disabled=false;}
this.folder.enableItemSelect(true);this.folder.enableItemEditor(true);this.folder.enableDragAndDrop(true);},loadFolder:function(xml,folder,refreshList){refreshList=!(refreshList===false);if(refreshList){mailViewer.close();}
this.folder.loadXML(xml);this.folder.showItemSign(1,false);this.folder.showItemLine(1,false);if(this.folder.getIndexById("shared")){this.folder.showItemSign("shared",false);this.folder.showItemLine("shared",false);}
if(folder){var id=parseInt(this.folder.getIdByData("HASH",folder));if(id>0){this.folder.focus(id);this.currentID=id;this.currentHash=folder;}else{id=2;this.folder.focus(id);this.currentID=id;}}else{this.folder.focus(this.currentID);}
mailControl.setReqFirst(true);if(refreshList){mailList.loadList.bind(mailList,true).defer();}
amtop.waitMailFolderPulldown(function(){mailControl.setup();});},refreshFolder:function(){mailFolderRequest.refreshFolder(this.onSuccessRefreshFolder.bind(this),this.onFailureRefreshFolder.bind(this));},onSuccessRefreshFolder:function(status,xml,folder){this.loadFolder(xml,this.currentHash||folder,false);},onFailureRefreshFolder:function(status,request,header){if(status<0){ammsg.error("RMAIL0270");}},onOpenFolder:function(id,state){if(state>0){amtop.cache.mailFolder.getNodeById(id).setAttribute("open","1");}else{amtop.cache.mailFolder.getNodeById(id).removeAttribute("open");}},onSelectFolder:function(id){if(id==1||id=="shared"){var resource=amtop.infoUpdater.getUnseenResource();this.folder.focus(this.currentID);if(Object.evalAmBoolean(amdata.sys.ENABLE_DISPLAYUNSEEN,amdata.usr.DISPLAY_UNSEEN)){var total_flag=Object.evalAmBoolean(amdata.sys.ENABLE_DISPLAY_UNSEENTOTAL);var open_flag=Object.evalAmBoolean(amdata.sys.ENABLE_AUTO_OPENFOLDER);this._updateUnseenNode(this.currentID,resource,total_flag,open_flag);}
return;}
if(!mailSearch.isOnAllSearch()&&(id==this.currentID)){var resource=amtop.infoUpdater.getUnseenResource();if(Object.evalAmBoolean(amdata.sys.ENABLE_DISPLAYUNSEEN,amdata.usr.DISPLAY_UNSEEN)){var total_flag=Object.evalAmBoolean(amdata.sys.ENABLE_DISPLAY_UNSEENTOTAL);var open_flag=Object.evalAmBoolean(amdata.sys.ENABLE_AUTO_OPENFOLDER);this._updateUnseenNode(id,resource,total_flag,open_flag);}
return;}
if(!id)id=this.currentID;var hash=this.folder.getDataById(id,"HASH");if(!hash)return;mailViewer.close();var prevID=this.currentID;var prevHash=this.currentHash;this.currentID=id;this.currentHash=hash;mailControl.setReqFirst(true);if(mailSearch.isOnAllSearch()){mailSearch.cancelSearch();}
if(mailList.loadList(true,this.onCompleteSelectFolder.bind(this))){this.folder.focus(id);}else{this.folder.focus(prevID);this.currentID=prevID;this.currentHash=prevHash;mailControl.setReqFirst(false);}},onCompleteSelectFolder:function(){mailControl.changeStatus();},isSystemFolder:function(id){if(!id)id=this.currentID;var hash=this.folder.getDataById(id,"HASH");if((hash==amdata.gen.PERSONAL_INBOX)||(hash==amdata.gen.PERSONAL_SENT)||(hash==amdata.gen.PERSONAL_TRASH)||(hash==amdata.gen.PERSONAL_DRAFTS)||(Object.evalAmBoolean(amdata.sys.DISP_JUNKMAIL)&&(hash==amdata.gen.PERSONAL_JUNKMAIL))){return true;}else{return false;}},isInbox:function(id){var hash=this.folder.getDataById(id||this.currentID,"HASH");if(hash==amdata.gen.PERSONAL_INBOX){return true;}else{return false;}},isDraft:function(id){var hash=this.folder.getDataById(id||this.currentID,"HASH");if(hash==amdata.gen.PERSONAL_DRAFTS){return true;}else{return false;}},isSent:function(id){var hash=this.folder.getDataById(id||this.currentID,"HASH");if(hash==amdata.gen.PERSONAL_SENT){return true;}else{return false;}},isTrash:function(id){var hash=this.folder.getDataById(id||this.currentID,"HASH");if(hash==amdata.gen.PERSONAL_TRASH){return true;}else{return false;}},isSharedFolder:function(id){return this.folder.getDataById(id,"TYPE")=="shared";},getCurrentFolder:function(strict){if(!strict&&mailSearch.isOnAllSearch()){return"all";}else{return this.currentHash;}},getCurrentFolderName:function(){if(mailSearch.isOnMultiSearch()){return"";}
return this.folder.getDataById(this.currentID,"NAME");},getFolderHash:function(id){return this.folder.getDataById(id,"HASH");},isAccess:function(id){return Object.evalAmBoolean(this.folder.getDataById(id,"ACCESS"));},allSearchOn:function(){this.folder.unfocus(this.currentID);},allSearchOff:function(){this.folder.focus(this.currentID);},_updateUnseenNode:function(node_id,resource,total,open){var count=this.folder.getChildCount(node_id);var childs_unseen_total=0;for(var i=0;i<count;i++){var child_id=this.folder.getChildItemIdByIndex(node_id,i);childs_unseen_total+=this._updateUnseenNode(child_id,resource,total,open);}
var node_hash=this.folder.getDataById(node_id,"HASH");var unseen=0;if(resource[node_hash]){unseen=parseInt(resource[node_hash].unseen);}
var pre_name=this.folder.getNameById(node_id);var name=this.folder.getDataById(node_id,"NAME");var tooltip=this.folder.getTooltipById(node_id);if(unseen>0){name+=" ("+unseen+")";}
if(total&&childs_unseen_total>0){name+=" +["+childs_unseen_total+"]";}
if(open&&childs_unseen_total>0){this.folder.open(node_id);amtop.cache.mailFolder.getNodeById(node_id).setAttribute("open","1");}
if(!this.isSent(node_id)&&!this.isDraft(node_id)&&(unseen||childs_unseen_total||pre_name!=name)){this.folder.setNameById(node_id,name,tooltip);amtop.cache.mailFolder.getNodeById(node_id).setAttribute("text",name);if(unseen||childs_unseen_total){this.folder.setSpanCss(node_id,"am_folder_bold");}else{this.folder.removeSpanCss(node_id,"am_folder_bold");}}
return unseen+childs_unseen_total;},updateUnseenAll:function(resource){if(!Object.evalAmBoolean(amdata.sys.ENABLE_DISPLAYUNSEEN,amdata.usr.DISPLAY_UNSEEN)){return;}
if(!resource){return;}
this.folder.stopEdit();var updateUnseenTree=function(root_id){var child_count=this.folder.getChildCount(root_id);var total_flag=Object.evalAmBoolean(amdata.sys.ENABLE_DISPLAY_UNSEENTOTAL);var open_flag=Object.evalAmBoolean(amdata.sys.ENABLE_AUTO_OPENFOLDER);for(var i=0;i<child_count;i++){var child_id=this.folder.getChildItemIdByIndex(root_id,i);this._updateUnseenNode(child_id,resource,total_flag,open_flag);}};var root_id=this.folder.getIdByIndex(0);updateUnseenTree.apply(this,[root_id]);if(this.folder.getIndexById("shared")){updateUnseenTree.apply(this,["shared"]);}
if(is.safari){$("mail_folder_xtree").style.width=$("mail_folder_xtree").clientWidth-1;$("mail_folder_xtree").style.width=$("mail_folder_xtree").clientWidth+1;$("mail_folder_xtree").style.width="";}},updateUnseenDiffCtrl:function(unseenList){if(!amtop.infoUpdater.unseenResource){this.updateUnseenDiffCtrl.bind(this).delay(0.1,unseenList);return;}
for(var key in unseenList){amtop.infoUpdater.updateUnseenResource(key,unseenList[key].unseen);}
var resource=amtop.infoUpdater.getUnseenResource();mailFolder.updateUnseenAll(resource);return;},_updateUnseen:function(node_id,unseen){if(!this.onEdit&&Object.evalAmBoolean(amdata.sys.ENABLE_DISPLAYUNSEEN,amdata.usr.DISPLAY_UNSEEN)){var hash=this.folder.getDataById(node_id,"HASH");if(!hash)return;var unseen_source=amtop.infoUpdater.updateUnseenResource(hash,unseen);if(Object.evalAmBoolean(amdata.sys.ENABLE_DISPLAY_UNSEENTOTAL)&&(Object.evalAmBoolean(amdata.sys.ENABLE_UNSEENUPDATE_INBOXSELECT)||Object.evalAmBoolean(amdata.sys.ENABLE_UPDATEUNSEEN)||Object.evalAmBoolean(amdata.sys.ENABLE_CHECKUNSEEN,amdata.usr.CHECKUNSEEN))){while(1){var tmp=this.folder.getParentId(node_id);if(!tmp||tmp==this.folder.getIdByIndex(0)||tmp=="shared"){break;}
node_id=tmp;}
this._updateUnseenNode(node_id,unseen_source,true);}else{var name=this.folder.getDataById(node_id,"NAME");var tooltip=this.folder.getTooltipById(node_id);if(!this.isDraft(node_id)&&!this.isSent(node_id)){if(unseen!="0"){name+=" ("+unseen+")";this.folder.setSpanCss(node_id,"am_folder_bold");}else{this.folder.removeSpanCss(node_id,"am_folder_bold");}}
this.folder.setNameById(node_id,name,tooltip);amtop.cache.mailFolder.getNodeById(node_id).setAttribute("text",name);}
if(is.safari){$("mail_folder_xtree").style.width=$("mail_folder_xtree").clientWidth-1;$("mail_folder_xtree").style.width=$("mail_folder_xtree").clientWidth+1;$("mail_folder_xtree").style.width="";}}},updateUnseen:function(unseen){return this._updateUnseen(this.currentID,unseen);},onXLE:function(){this.treeReady=true;if(Object.evalAmBoolean(amdata.sys.ENABLE_DISPLAYUNSEEN,amdata.usr.DISPLAY_UNSEEN)&&(Object.evalAmBoolean(amdata.sys.ENABLE_UNSEEN_DIFFCONTROL)||((Object.evalAmBoolean(amdata.sys.ENABLE_CHECKUNSEEN,amdata.usr.CHECKUNSEEN)&&Object.evalAmBoolean(amdata.sys.ENABLE_AUTO_UPDATEUNSEEN))||Object.evalAmBoolean(amdata.sys.ENABLE_UPDATEUNSEEN)||Object.evalAmBoolean(amdata.sys.ENABLE_UNSEENUPDATE_INBOXSELECT)))){if(!Object.evalAmBoolean(amdata.sys.ENABLE_CHECKUNSEEN,amdata.usr.CHECKUNSEEN)&&!Object.evalAmBoolean(amdata.sys.ENABLE_UNSEEN_DIFFCONTROL)&&!amtop.firstRmailOpen){amtop.firstRmailOpen=true;}else{delete(amtop.infoUpdater.unseenResource);amtop.infoUpdater.update(true);}}},onDragEnd:function(){var boldflg=1;if(!this.folder.indexOfSpanCss(this.currentID,"am_folder_bold")){boldflg=0;}
this.folder.focus(this.currentID,false);this.onDragProcessing=false;this.onDragging=false;if(boldflg){this.folder.setSpanCss(this.currentID,"am_folder_bold");}},onCreateDragNode:function(id){return(this.folder.getDataById(id,"NAME")||"");},onEditFolder:function(state,id,obj,value){switch(state){case 0:if(!Object.evalAmBoolean(amdata.sys.ENABLE_FOLDER_CONTROL)||!Object.evalAmBoolean(this.folder.getDataById(id,"EDIT"))){return false;}
this.previousName=this.folder.getNameById(id);var name=this.folder.getDataById(id,"NAME");this.folder.setNameById(id,name);this.onEdit=true;return name.unescapeHTMLText();case 1:break;case 2:return value.escapeHTML();case 3:this.onEdit=false;var name=this.folder.getNameById(id).wstrip();if(name==this.folder.getDataById(id,"NAME")){this.folder.setNameById(id,this.previousName);this.folder.focus(this.currentID);return false;}
name=name.unescapeHTML();if(name.wblank()){this.folder.setNameById(id,this.previousName);this.folder.focus(this.currentID);ammsg.error('RMAIL0580');return false;}
if(name.search(amdata.gen.FILTER_MAILFOLDER_FULLNAME)!=-1){this.folder.setNameById(id,this.previousName);this.folder.focus(this.currentID);ammsg.error('RMAIL0050');return false;}
var hash=this.folder.getDataById(id,"HASH");this.currentID=id;mailFolderRequest.renameFolder(hash,name,this.onSuccessEdit.bind(this),this.onFailureEdit.bind(this));break;default:return false;}
return true;},onSuccessEdit:function(status,xml,folder){mailList.stopUpdateUnseenCancel=false;this.loadFolder(xml,folder);},onFailureEdit:function(status,request,header){switch(status){case-3:ammsg.error("RMAIL0050");break;case-2:ammsg.error("RMAIL0420");break;case-1:ammsg.error('RMAIL0060');break;default:break;}
this.folder.setNameById(this.currentID,this.previousName);this.folder.focus(this.currentID);},onBeforeDrag:function(id){if(Object.evalAmBoolean(amdata.sys.ENABLE_FOLDER_CONTROL)&&Object.evalAmBoolean(this.folder.getDataById(id,"DRAG"))){return this.onDragging=true;}
return false;},onDragAndDrop:function(srcId,tgtId,flag,srcObj,tgtObj){if(this.onDragProcessing){return false;}
this.onDragProcessing=true;if(srcObj!=tgtObj){this.folder.focus(this.currentID,false);mailList.dragMailToFolder(srcId,tgtId);return false;}
if(!Object.evalAmBoolean(amdata.sys.IMAP_INFERIOR)){if(Object.evalAmBoolean(this.folder.getDataById(tgtId,"ACCESS"))){ammsg.error("RMAIL0260");this.folder.focus(this.currentID,false);return false;}}
if(!Object.evalAmBoolean(amdata.sys.ENABLE_FOLDER_CONTROL)||!(Object.evalAmBoolean(this.folder.getDataById(srcId,"DRAG"))&&Object.evalAmBoolean(this.folder.getDataById(tgtId,"DROP"))&&(this.folder.getParentId(srcId)!=tgtId))){this.folder.focus(this.currentID,false);return false;}
var srcHash=this.folder.getDataById(srcId,"HASH");if(!srcHash){this.folder.focus(this.currentID,false);return false;}
var tgtHash=this.folder.getDataById(tgtId,"HASH");if(!tgtHash){tgtHash="all";}
ammsg.confirm("GENERAL0100",{"$src_folder":this.folder.getDataById(srcId,"NAME"),"$tgt_folder":this.folder.getDataById(tgtId,"NAME")},(function(status){if(status==1){var onSuccess=this.onSuccessDrop.bind(this);var onFailure=this.onFailureDrop.bind(this);(function(){mailFolderRequest.moveFolder(srcHash,tgtHash,onSuccess,onFailure);}).defer();}}).bind(this));return false;},onSuccessDrop:function(status,xml,folder){this.loadFolder(xml,folder);},onFailureDrop:function(status,request,header){switch(status){case-3:ammsg.error("RMAIL0050");break;case-2:ammsg.error("RMAIL0420");break;case-1:ammsg.error('GENERAL0110');break;default:break;}
this.folder.focus(this.currentID,false);},displayCreateFolderForm:function(){this._displayCreateFolderForm(this.currentID);},displayCreateFolderForm_callContextMenu:function(sel_id){this._displayCreateFolderForm(sel_id);},_displayCreateFolderForm:function(id){var title=this.formTitle;var html=this.formSource;var height=200;if(Object.evalAmBoolean(amdata.sys.IMAP_INFERIOR)){var options=new Array();options.push("<option value='all'>/</option>");var ids=this.folder.getAllItemIds();var len=ids.length;for(i=2;i<len;i++){if(!Object.evalAmBoolean(this.folder.getDataById(ids[i],"EDIT"))){continue;}
var path=this.folder.getFullName(ids[i],1,"NAME");var hash=this.folder.getDataById(ids[i],"HASH");if(ids[i]==id){options.push("<option value='"+hash+"' selected='selected'>"+path+"</option>");}else{options.push("<option value='"+hash+"'>"+path+"</option>");}}
html=html.split("$$$$OPTION_FOLDER_LIST$$$$").join(options.join(""));}
amvpop.openModalWindow(html,title,400,height);},createFolder:function(f){var el=f.new_folder_name;var new_name=el.value;new_name=new_name.wstrip();el.value=new_name;if(new_name==""){ammsg.statusError("RMAIL0580");return;}
if(new_name.search(amdata.gen.FILTER_MAILFOLDER_NODENAME)!=-1){ammsg.statusError("RMAIL0050");return;}
if(Object.evalAmBoolean(amdata.sys.IMAP_INFERIOR)){if(new_name.indexOf("/")!=-1){ammsg.statusError("RMAIL0050");return;}}else{var names=new_name.split("/");var len=names.length;if(len>=10){ammsg.statusError("RMAIL0420");return;}
for(var i=0;i<len;i++){if(names[i].wblank()){ammsg.statusError("RMAIL0050");return;}}}
amvpop.lock();amapp.freeze();var parentHash="";if(Object.evalAmBoolean(amdata.sys.IMAP_INFERIOR)){parentHash=f.parent_folder.value;}
mailFolderRequest.createFolder(parentHash,new_name,this.onSuccessCreate.bind(this),this.onFailureCreate.bind(this));},cancelCreateFolder:function(){amvpop.closeWindow();},onSuccessCreate:function(status,xml,folder){amapp.unfreeze();amvpop.unlock();amvpop.closeWindow();this.loadFolder(xml,folder);},onFailureCreate:function(status,request,header){amapp.unfreeze();amvpop.unlock();switch(status){case-3:ammsg.statusError("RMAIL0050");break;case-2:ammsg.statusError("RMAIL0420");break;case-1:ammsg.statusError('RMAIL0060');break;default:break;}},confirmDeleteFolder:function(){this._confirmDeleteFolder(this.currentID);},confirmDeleteFolder_callContextMenu:function(sel_id){this.cm_currentHash=this.folder.getDataById(sel_id,"HASH");this._confirmDeleteFolder(sel_id,true);},_confirmDeleteFolder:function(id,call_context){var name=this.folder.getDataById(id,"NAME");if(!name)return;if(this.isSystemFolder(id)){ammsg.info("RMAIL0570",{$foldername:name});return;}
var count=this.folder.getChildCount(id);if(count>0){ammsg.confirm("RMAIL0560",{$foldername:name},call_context?this.deleteFolder_callContextMenu.bind(this):this.deleteFolder.bind(this));}else{ammsg.confirm("RMAIL0520",{$foldername:name},call_context?this.deleteFolder_callContextMenu.bind(this):this.deleteFolder.bind(this));}},deleteFolder:function(status){if(status==1){mailFolderRequest.deleteFolder(this.currentHash,this.onSuccessDeleteFolder.bind(this),this.onFailureDeleteFolder.bind(this));}},deleteFolder_callContextMenu:function(status){if(status==1){mailFolderRequest.deleteFolder(this.cm_currentHash,this.onSuccessDeleteFolder.bind(this),this.onFailureDeleteFolder.bind(this));}},onSuccessDeleteFolder:function(status,xml,folder){ammsg.info('RMAIL0530');this.loadFolder(xml,folder);},onFailureDeleteFolder:function(status,request,header){if(status<0){ammsg.error('RMAIL0540');}},updateFolderUnseen:function(){amtop.infoUpdater.update(true);amtop.infoUpdater.onceComplete=mailControl.reload.bind(mailControl);}});var MailList=Class.create();Object.extend(MailList.prototype,{elPrevPage:null,elPrevDisable:null,elNextPage:null,elNextDisable:null,elPageSizeSelect:null,elPageSelect:null,elMaxPage:null,elFolderName:null,elUnseen:null,elTotal:null,elFolderSize:null,elSearchTitle:null,clUnseen:"",txtSearchEmpty:"",txtSubject:"",txtFolderSubject:"",txtSender:"",txtRecipient:"",sortList:null,list:null,currentID:0,currentUnseen:0,currentRealUnseen:0,page:1,pageSize:parseInt(amcache.PAGESIZE||amdata.usr.PAGESIZE),maxPage:0,sort:"R_DATE",onCompleteFunc:null,onEmptySearch:false,locked:false,onDragProcessing:false,onDragging:false,autoSelectId:0,initialize:function(args){this.container_element=$(args.container_element);this.grid_element=$(args.grid_element);this.pager_element=$(args.pager_element);this.container_element.prepareBoxMethods();this.grid_element.prepareBoxMethods();this.pager_element.prepareBoxMethods();this.grid_element.setBorderBoxHeight(this.container_element.getContentBoxHeight()-
this.pager_element.getBorderBoxHeight());this.createList(args.idArea,args.header_columns,args.header_order);this.elPrevPage=$(args.idPrevPage);this.elPrevPage.observe("click",this.prevPage.bind(this));this.elPrevDisable=$(args.idPrevDisable);this.elNextPage=$(args.idNextPage);this.elNextPage.observe("click",this.nextPage.bind(this));this.elNextDisable=$(args.idNextDisable);this.elPageSizeSelect=$(args.idPageSizeSelect);this.elPageSizeSelect.observe("change",this.changePageSize.bind(this));this.elPageSelect=$(args.idPageSelect);this.elMaxPage=$(args.idMaxPage);this.elFolderName=$(args.idFolderName);this.elUnseen=$(args.idUnseen);this.elTotal=$(args.idTotal);this.elFolderSize=$(args.idFolderSize);this.elSearchTitle=$(args.idSearchTitle);this.clUnseen=args.clUnseen;this.txtSearchEmpty=args.txtSearchEmpty;this.txtSubject=args.txtSubject;this.txtFolderSubject=args.txtFolderSubject;this.txtSender=args.txtSender;this.txtRecipient=args.txtRecipient;this.txtPriorityDefault=args.txtPriorityDefault;this.txtPriorityAsc=args.txtPriorityAsc;this.txtPriorityDesc=args.txtPriorityDesc;this.sortList=args.sortList;if(args.contextMenu){args.contextMenu.list=this.list;this.contextMenu=new RmailGridContextMenu(args.contextMenu);}
this.elPageSizeSelect.setValue(this.pageSize);if(parseInt(this.elPageSizeSelect.value)!=this.pageSize){this.elPageSizeSelect.selectedIndex=0;this.pageSize=parseInt(this.elPageSizeSelect.value);amcache.PAGESIZE=this.pageSize.toString();}},createList:function(idArea,header_columns,header_order){header_order=header_order.split(',');if(!Object.evalAmBoolean(amdata.sys.ENABLE_TOOL_SPAM)&&!Object.evalAmBoolean(amdata.sys.ENABLE_AH_SPAMFILTER)){header_order=header_order.without('spam');}
else if(!Object.evalAmBoolean(amdata.sys.DISP_JUNKMAIL))
{header_order=header_order.without('spam');}
header_columns=header_order.map(function(key){return header_columns.find(function(column){return column.id===key;});});var enable_shortcut=amapp.enabledKeyboardShortcut();var args={id:idArea,header:header_columns,options:{HeightFix:-2,RowHeight:22,DragAndDrop:true,AlterCss:true,RowsHover:true,ColSpan:true,SynchronizedChecking:true,Focusing:enable_shortcut,SmartRendering:true,AutoRendering:true},listeners:{BeforeSelect:this.onBeforeSelect.bind(this),BeforeDrag:this.onBeforeDrag.bind(this),RowSelect:this.onSelectRow.bind(this),HeaderClick:this.onSortList.bind(this),RowToDrag:this.onCreateDragNode.bind(this),DragIn:this.onDragIn.bind(this),DragEnd:this.onDragEnd.bind(this),RowDblClicked:this.onOpenMailWindow.bind(this)}};this.list=new am.XGrid(args);},onBeforeDrag:function(){return this.onDragging=true;},saveScrollTop:function(){this.beforeScrollTop=this.list.getScrollTop();},returnScrollTop:function(){if(this.beforeScrollTop){this.list.setScrollTop(this.beforeScrollTop);delete this.beforeScrollTop;}},clearScrollTop:function(){if(this.beforeScrollTop){delete this.beforeScrollTop;}},saveFocusUid:function(){var id=this.list.getFocusedRowId();this.selectedFocusedUid=this.list.getUserData(id,"uid")},saveFocusIndex:function(){if(amdata.sys.ENABLE_RMAIL_CHECKSTATE_KEEP!="on"){return;}
this.selectedFocusedIndex=this.list.getFocusedRowId();},returnFocus:function(){var set=false;var ids=this.list.getAllRowIds();if(this.selectedFocusedUid){for(var i=0;i<ids.length;i++){var uid=this.list.getValue(ids[i],"uid");if(uid==this.selectedFocusedUid){this.focusRow(ids[i]);set=true;break;}}
delete this.selectedFocusedUid;}else if(this.selectedFocusedIndex&&this.selectedIndexes){if(ids.length>0){if(this.selectedIndexes.length>0&&this.selectedIndexes[0]>ids.length){this.focusRow(ids[ids.length-1]);}else{this.focusRow(this.selectedIndexes[0]);}
set=true;}
delete this.selectedFocusedIndex;}
if(!set){this.focusRow(1);}},clearFocus:function(){if(this.selectedFocusedUid){delete this.selectedFocusedUid;}
if(this.selectedFocusedIndex){delete this.selectedFocusedIndex;}},saveSelectRowUids:function(){this.selectedUids=this.getSelectedUids();},saveSelectRowIndexes:function(){if(amdata.sys.ENABLE_RMAIL_CHECKSTATE_KEEP!="on"){return;}
this.selectedIndexes=this.list.getCheckedRows();},autoViewSelectedRow:function(id){if(amdata.sys.ENABLE_RMAIL_AUTOVIEW_SELECTED!="on"){return;}
if(mailLock.locked){window.setTimeout(function(){this.autoViewSelectedRow(id);}.bind(this),100);return;}
var tgtId=parseInt(id);if(mailViewer.isOpened()&&(tgtId==this.currentID)){if(!mailLayout.visible('view')){mailLayout.hide("list");this.setInactive();}
return;}
var uid=this.list.getUserData(id,"uid");var folder=this.list.getUserData(id,"folder");if(!uid||!folder){return;}
this.setInactive();this.currentID=tgtId;mailViewRequest.readMail(folder,uid,this.successOnSelect.bind(this),this.failureOnSelect.bind(this));},returnSelectRow:function(){if(this.selectedUids&&this.selectedUids.length>0){var ids=this.list.getAllRowIds();for(var i=0;i<ids.length;i++){var uid=this.list.getValue(ids[i],"uid");for(var j=0;j<this.selectedUids.length;j++){if(uid==this.selectedUids[j]){this.list.setCheckState(ids[i],1);}}}
delete this.selectedUids;}else if(this.selectedIndexes&&this.selectedIndexes.length>0){var list=this.list;var ids=list.getAllRowIds();if(this.selectedIndexes[0]>ids.length){if(ids.length>0){list.setCheckState(ids[ids.length-1],1);this.autoViewSelectedRow(ids[ids.length-1]);}}else{list.setCheckState(this.selectedIndexes[0],1);this.autoViewSelectedRow(this.selectedIndexes[0]);}
delete this.selectedIndexes;}},clearSelectRow:function(){if(this.selectedUids){delete this.selectedUids;}
if(this.selectedIndexes){delete this.selectedIndexes;}},lock:function(){this.elPageSizeSelect.disabled=true;if(this.elPageSelect.firstChild){this.elPageSelect.firstChild.disabled=true;}
this.list.enableSelection(false);this.list.enableDragAndDrop(false);this.locked=true;},unlock:function(){this.elPageSizeSelect.disabled=false;if(this.elPageSelect.firstChild){this.elPageSelect.firstChild.disabled=false;}
this.list.enableSelection(true);if(!this.onEmptySearch){this.list.enableDragAndDrop(true);}
this.locked=false;},setActive:function(){if(!is.ie&&document.activeElement){document.activeElement.blur();}
this.list.setActive(true);},setInactive:function(){this.list.setActive(false);},makeMailInfo:function(ids){var mails=new Array();var len=ids.length;for(var i=0;i<len;i++){mails.push({folder:this.list.getUserData(ids[i],"folder"),uid:this.list.getUserData(ids[i],"uid")});}
return mails;},getSelectedUids:function(){return this.list.getCheckedValues('uid');},getSelectedMails:function(){if(this.onEmptySearch){return null;}
return this.makeMailInfo(this.list.getCheckedRows());},getCurrentPage:function(){return this.page;},getPageSize:function(){return this.pageSize;},getSortCondition:function(){var first=this.sort;var second='R_DATE';if(mailFolder.isDraft()||mailFolder.isSent()){if(first=='FROM'){first='TO';}else if(first=='R_FROM'){first='R_TO';}}else{if(first=='TO'){first='FROM';}else if(first=='R_TO'){first='R_FROM';}}
if((first=='DATE')||(first=='R_DATE')){second='R_UID';}
return[first,second];},searchOn:function(){Element.show(this.elSearchTitle);},searchOff:function(){Element.hide(this.elSearchTitle);},setSizes:function(){try{this.grid_element.setBorderBoxHeight(this.container_element.getContentBoxHeight()-
this.pager_element.getBorderBoxHeight());this.list.setSizes();}catch(e){}},focusRow:function(id){this.list.focus(id);},focusPrevRow:function(){if(this.onEmptySearch){return;}
id=this.list.getFocusedRowId();this.list.focus(id?id-1:1);},focusNextRow:function(){if(this.onEmptySearch){return;}
id=this.list.getFocusedRowId();this.list.focus(id?id+1:1);},getFocusedRow:function(){return this.list.getFocusedRowId();},toggleCheckRow:function(id){if(!id){return;}
this.list.toggleCheckState(id);},selectRow:function(id){this.list.selectRowById(id,false,true,true);},isEnablePrevious:function(id){if(!id)id=this.currentID;return((this.page>1)||this.list.getUserData(id-1,"uid"));},selectPreviousRow:function(id){if(!id)id=this.currentID;if(id==1){this.autoSelectId=this.getPageSize();this.prevPage();}else{this.selectRow(id-1);}},isEnableNext:function(id){if(!id)id=this.currentID;return((this.page<this.maxPage)||this.list.getUserData(id+1,"uid"));},selectNextRow:function(id){if(!id)id=this.currentID;if(id==this.getPageSize()){this.autoSelectId=1;this.nextPage();}else{this.selectRow(id+1);}},onSelectRow:function(id){this.focusRow(id);var tgtId=parseInt(id);if(mailViewer.isOpened()&&(tgtId==this.currentID)){if(!mailLayout.visible('view')){mailLayout.hide("list");this.setInactive();}
return;}
var uid=this.list.getUserData(id,"uid");var folder=this.list.getUserData(id,"folder");if(!uid||!folder){return;}
this.setInactive();this.currentID=tgtId;mailViewRequest.readMail(folder,uid,this.successOnSelect.bind(this),this.failureOnSelect.bind(this));},_onSelectRow:function(folder,uid){mailViewRequest.readMail(folder,uid,this.successOnSelect.bind(this),this.failureOnSelect.bind(this));},withImageHtml:function(folder,uid){if(!folder||!uid){return;}
mailViewRequest.withImageHtmlMail(folder,uid,this.successOnSelect.bind(this),this.failureOnSelect.bind(this));},successOnSelect:function(){amtop.recentUpdater.stopRecentNoteIfAtLogin();var id=this.currentID;if(this.list.hasClassName(id,this.clUnseen)){var icon=this.list.getCellValue(id,1);icon=icon.replace(/mail.gif"/,"mail_read.gif\"");this.list.setCellValue(id,1,icon);this.list.removeClassName(id,this.clUnseen);this.currentUnseen=this.currentUnseen-1;if(this.currentUnseen<0){this.currentUnseen=0;}
this.currentRealUnseen=this.currentRealUnseen-1;if(this.currentRealUnseen<0){this.currentRealUnseen=0;}
this.elUnseen.innerHTML=this.currentUnseen.toString();var _id=mailFolder.currentID;var _unseen=this.currentRealUnseen.toString();window.setTimeout(function(){mailFolder._updateUnseen(_id,_unseen);},500);}
if(mailLayout.visible('list')){this.setActive();}},failureOnSelect:function(){this.currentID=0;this.list.clearCheck();mailViewer.close();this.setActive();},setContextMenuEvents:function(){this.contextMenu.setItemsHandler([{name:"reply",handler:mailControl.reply},{name:"replyAll",handler:mailControl.replyAll},{name:"forward",handler:mailControl.forward},{name:"seen",handler:mailControl.setSeen},{name:"unseen",handler:mailControl.setUnseen},{name:"setflag",handler:mailControl.setFlag},{name:"unsetflag",handler:mailControl.unsetFlag},{name:"movetrash",handler:mailControl.moveTrash.bind(mailControl)},{name:"delmail",handler:mailControl.confirmDeleteMail.bind(mailControl)}]);},setEmptySearch:function(){this.list.enableDragAndDrop(false);this.list.setColType(0,"rotxt");this.list.enableSynchronizedChecking(false);this.list.addRow(1,this.txtSearchEmpty);this.list.addClassName(1,this.clUnseen);this.list.setColspan(1,0);this.onEmptySearch=true;if(this.contextMenu){this.contextMenu.detachShowHandler();}},unsetEmptySearch:function(){this.list.enableDragAndDrop(true);this.list.setColType(0,"ch");this.list.enableSynchronizedChecking(true);this.onEmptySearch=false;if(this.contextMenu){this.contextMenu.attachShowHandler();}},loadList:function(resetPage,onComplete){if(resetPage){this.page=1;}
this.onCompleteFunc=onComplete;var folder=mailFolder.getCurrentFolder(true);if(this.onEmptySearch){this.unsetEmptySearch();}
return mailListRequest.loadList(folder,this.onSuccessLoadList.bind(this),this.onFailureLoadList.bind(this));},furiwake:function(onComplete){this.onCompleteFunc=onComplete;var folder=mailFolder.getCurrentFolder(true);if(this.onEmptySearch){this.unsetEmptySearch();}
return mailListRequest.furiwake(folder,this.onSuccessLoadList.bind(this),this.onFailureLoadList.bind(this));},stopUpdateUnseenCancel:true,onSuccessLoadList:function(status,xml,total,unseen,realUnseen,size,current,max,result,sort,refreshFolder,popNumber,popResult,adminPopNumber,adminPopResult,unseenUpdate){this.list.update(xml);if(this.autoSelectId){this.selectRow.bind(this,this.autoSelectId).defer();}else{mailViewer.close();this.returnFocus();mailList.list.focusReRendering.bind(mailList.list).delay(0.1);this.returnSelectRow();}
this.autoSelectId=0;this.returnScrollTop();var receiptIndex=this.list.getColumnIndex('receipt');var subjectIndex=this.list.getColumnIndex('subject');if(mailFolder.isDraft()||mailFolder.isSent()){this.list.setColumnLabel(receiptIndex,this.txtRecipient);}else{this.list.setColumnLabel(receiptIndex,this.txtSender);}
if(mailSearch.isOnMultiSearch()){this.list.setColumnLabel(subjectIndex,this.txtFolderSubject);}else{this.list.setColumnLabel(subjectIndex,this.txtSubject);}
if(mailSearch.isOnSearch()&&(result==0)){this.setEmptySearch();}
if(unseen<0){unseen=0;}
this.currentUnseen=unseen;if(realUnseen<0){realUnseen=0;}
this.currentRealUnseen=realUnseen;if(total<0){total=0;}
if(this.pageSize>0){max=Math.floor(((total>0)?(total-1):0)/this.pageSize)+1;}
var folderName=mailFolder.getCurrentFolderName().unescapeHTMLText();this.elFolderName.innerHTML=folderName.truncate(10).escapeHTML();this.elFolderName.title=folderName;this.elUnseen.innerHTML=unseen.toString();this.elTotal.innerHTML=total.toString();this.elFolderSize.innerHTML=size;if(unseenUpdate){if(this.stopUpdateUnseenCancel){amtop.infoUpdater.stopUpdateUnseen();}else{this.stopUpdateUnseenCancel=true;}
mailFolder.updateUnseenDiffCtrl(unseenUpdate);}else{var _id=mailFolder.currentID;var _unseen=realUnseen.toString();window.setTimeout(function(){mailFolder._updateUnseen(_id,_unseen);},500);}
if(current<1){current=1;}
if(max<1){max=1;}
this.setupPageSelector(current,max);this.sort=sort;this.setSortingImage();this.currentID=0;if(refreshFolder){(function(){mailFolder.refreshFolder();}).defer();}
if(amdata.sys.EXTRA_POP_DISPLAY_MESSAGE=="on"){if(adminPopResult){adminPopResult=new am.PropList(eval(adminPopResult));mailControl.displayAdminPopResult(adminPopResult);}
if(popResult){popNumber=parseInt(popNumber);popResult=new am.PropList(eval(popResult));mailControl.displayPopResult(popNumber,popResult,true);}}
if(mailFolder.isInbox()&&Object.evalAmBoolean(amdata.sys.ENABLE_DISPLAYUNSEEN,amdata.usr.DISPLAY_UNSEEN)&&Object.evalAmBoolean(amdata.sys.ENABLE_UNSEENUPDATE_INBOXSELECT)){amtop.infoUpdater.update(true);}
amtop.recentUpdater.stopRecentNote();(this.onCompleteFunc||Prototype.emptyFunction)();},onFailureLoadList:function(status,request){mailViewer.close();if(status<0){ammsg.error("RMAIL0280",{$errcode:status});}
(this.onCompleteFunc||Prototype.emptyFunction)();},setupPageSelector:function(current,max){if(current==1){Element.hide(this.elPrevPage);Element.show(this.elPrevDisable);}else{Element.show(this.elPrevPage);Element.hide(this.elPrevDisable);}
if(current>=max){Element.hide(this.elNextPage);Element.show(this.elNextDisable);current=max;}else{Element.show(this.elNextPage);Element.hide(this.elNextDisable);}
this.page=current;if(max!=this.maxPage){var options=new Array();for(var i=1;i<=max;i++){options.push("<option value='"+i+"'>"+i+"</option>");}
this.elPageSelect.innerHTML="<select onchange=\"mailList.selectPage(event);\">"+options.join("")+"</select>";this.maxPage=max;}
this.elPageSelect.firstChild.selectedIndex=current-1;this.elMaxPage.innerHTML=max.toString();},setSortingImage:function(){var label;var asc=true;for(var key in this.sortList){if(this.sortList[key][0]==this.sort){label=key;}else if(this.sortList[key][1]==this.sort){label=key;asc=false;}}
if(!label){return;}
if((label=='from')||(label=='to')){label='receipt';}
var index=this.list.getColumnIndex(label);if(index>=0){if(label=='priority'){this.list.setColumnLabel(index,asc?this.txtPriorityAsc:this.txtPriorityDesc);}else{this.list.setColumnLabel(this.list.getColumnIndex('priority'),this.txtPriorityDefault);this.list.setSortImgState(true,index,asc?'asc':'desc');}}},changePageSize:function(){this.pageSize=parseInt(this.elPageSizeSelect.value);amcache.PAGESIZE=this.pageSize.toString();this.loadList(true);},prevPage:function(){if(this.locked)return;if(this.page-1<=0){return;}
this.page=this.page-1;this.loadList(false);},nextPage:function(){if(this.locked)return;if(this.page+1>this.maxPage){return;}
this.page=this.page+1;this.loadList(false);},selectPage:function(){this.page=parseInt(this.elPageSelect.firstChild.value);this.loadList(false);},onSortList:function(index){if(this.locked||this.onEmptySearch){return;}
var label=this.list.getColumnId(index);if(label=='receipt'){if(mailFolder.isDraft()||mailFolder.isSent()){label='to';}else{label='from';}}
var prevSort=this.sort;try{var sort=this.sortList[label];if(this.sort==sort[0]){this.sort=sort[1];}else{this.sort=sort[0];}}catch(e){return;}
if(!this.loadList(false)){this.sort=prevSort;}},onDragIn:function(){return false;},onDragEnd:function(){mailFolder.onDragEnd();this.onDragProcessing=false;this.onDragging=false;},shortcutOpenMail:function(){var id=this.getFocusedRow();var uid=this.list.getUserData(id,"uid");var folder=this.list.getUserData(id,"folder");if(!uid||!folder){return;}
mailViewer.popupFromKeybord(folder,uid);},onOpenMailWindow:function(id){var uid=this.list.getUserData(id,"uid");var folder=this.list.getUserData(id,"folder");if(!uid||!folder){return;}
mailViewer.popup(folder,uid);},getDraggedIds:function(id){var ids=this.list.getCheckedRows();if(ids.include(id)){return ids;}else{return[id];}},getDraggedMails:function(id){return this.makeMailInfo(this.getDraggedIds(id));},dragMailToFolder:function(id,folderId){if(amdata.usr.CONFIRM_DRAG_DROP=="on"){ammsg.confirm("RMAIL0640",{"$foldername":mailFolder.folder.getDataById(folderId,"NAME")},(function(status){if(status==1){mailControl.moveMail(this.getDraggedMails(id),folderId,this.onSuccessDragMailToFolder.bind(this));}}).bind(this));}else{mailControl.moveMail(this.getDraggedMails(id),folderId,this.onSuccessDragMailToFolder.bind(this));}},onSuccessDragMailToFolder:function(status,param){if(status<0){if(status==-2){ammsg.error('RMAIL0602');}else if(param.errorStatus=='permission'){ammsg.error('RMAIL0601');}else{ammsg.error("RMAIL0600");}}
if(param.unseenUpdate){amtop.infoUpdater.stopUpdateUnseen();mailFolder.updateUnseenDiffCtrl(param.unseenUpdate);}},onCreateDragNode:function(id){var ids=this.getDraggedIds(id);var text=new Array();var len=ids.length;for(var i=0;i<len;i++){if(i>10){text.push("...");break;}
text.push(this.list.getCellValue(ids[i],"subject"));}
return text.join("<br />");},onBeforeSelect:function(){return!this.locked;}});var MailControl=Class.create();Object.extend(MailControl.prototype,{popMessages:null,reqFirst:true,pulldown:null,currentPopupId:null,deleteMails:null,initialize:function(args){var MenuItem=Class.create({initialize:function(name,source,type){if((name=="move")||(name=="copy")||(name=="move_shared")||(name=="copy_shared")){type="menu";}
this.type=type;this.id="_mail_action_"+this.type+"_"+name;this.label=source.label;this.icon=source.icon;this.css=source.submenu?"clones-popup-"+args.idFolderSubMenu:(source.subshared?"clones-popup-"+args.idSharedFolderSubMenu:"");if(!source.action){this.action="retval = true;";if(source.action==""){this.css+=" disabled";}}else{this.action="mailControl."+source.action+"();";}},enable:function(){if(!this.action){return;}
if(this.type=="button"){(this.el?this.el:(this.el=$(this.id))).enable();}else if(this.type=="menu"){if(mailControl.pulldown){mailControl.pulldown.enable(this.id);}}},disable:function(){if(this.type=="button"){(this.el?this.el:(this.el=$(this.id))).disable();}else if(this.type=="menu"){if(mailControl.pulldown){mailControl.pulldown.disable(this.id);}}},remove:function(){if(!this.el){this.el=$(this.id);}
this.el.remove();}});this.items={};$(args.idButtons).innerHTML=amdata.usr.MAILACTION_BUTTON_ITEMS.split(",").map(function(name){var item=args.items[name];if(!item){return"";}
this.items[name]=new MenuItem(name,item,"button");return args.buttonTemplate.interpolate(this.items[name]);},this).join("");$(args.idMenuItems).innerHTML=amdata.usr.MAILACTION_MENU_ITEMS.split(",").map(function(name){if(name=="hr"){return"<li></li>";}
var item=args.items[name];if(!item){return"";}
this.items[name]=new MenuItem(name,item,"menu");return args.menuTemplate.interpolate(this.items[name]);},this).join("");this.folderSubMenu=$(args.idFolderSubMenu);this.sharedfolderSubMenu=$(args.idSharedFolderSubMenu);this.elFilter=$(args.idFilter);this.elFilter.observe("change",this.filter.bind(this));this.idMenu=args.idMenu;this.popMessages=args.popMessages;},lock:function(){this.elFilter.disabled=true;for(var name in this.items){if(this.items[name].type=="button"){this.items[name].disable();}}
if(this.pulldown){this.pulldown.disable();}},unlock:function(){this.elFilter.disabled=false;for(var name in this.items){if(this.items[name].type=="button"){this.items[name].enable();}}
if(this.pulldown){this.pulldown.enable();}
if(mailFolder.getCurrentFolder()==amdata.gen.PERSONAL_DRAFTS){if(this.items.reply){this.items.reply.disable();}
if(this.items.replyAll){this.items.replyAll.disable();}
if(this.items.forward){this.items.forward.disable();}}
if(mailFolder.getCurrentFolder()==amdata.gen.PERSONAL_TRASH){if(this.items.trash){this.items.trash.disable();}}
if(mailFolder.isSharedFolder(mailFolder.currentID)){if(this.items.furiwake){this.items.furiwake.disable();}}
if(this.items.pop&&this.items.pop.css){if(this.items.pop.css.wstrip()=="disabled"){this.items.pop.disable();}}},searchOn:function(){},searchOff:function(){},setup:function(){this.folderSubMenu.innerHTML=amtop.cache.mailFolderPulldown.get("mailControl.mailActionToFolder");var data=amtop.cache.sharedFolderPulldown.get("mailControl.mailActionToFolder");if(data){this.sharedfolderSubMenu.innerHTML=data;}else{if(this.items.move_shared){this.items.move_shared.remove();}
if(this.items.copy_shared){this.items.copy_shared.remove();}}
if(this.pulldown){this.pulldown.rebuild();}else{var option={lazy:true,scrolling:true,tooltips:true,onPopup:this.onPopupMailAction.bind(this)}
this.pulldown=new am.PulldownMenu(this.idMenu,option);}
this.changeStatus();},checkMovable:function(mails,tgtFolder){var len=mails.length;for(var i=0;i<len;i++){if(mails[i].folder!=tgtFolder){return true;}}
return false;},onPopupMailAction:function(target,item,pos){if(item.id){this.currentPopupId=item.id;}},mailActionToFolder:function(el,folderId){if(this.items.move&&((this.currentPopupId==this.items.move.id)||(this.items.move_shared&&this.currentPopupId==this.items.move_shared.id))){this.moveMailToFolder(folderId);}else if(this.items.copy&&((this.currentPopupId==this.items.copy.id)||(this.items.copy_shared&&this.currentPopupId==this.items.copy_shared.id))){this.copyMailToFolder(folderId);}},moveMailToFolder:function(folderId){var mails=mailList.getSelectedMails();if(!mails||(mails.length==0)){ammsg.error("RMAIL0160");return;}
this.moveMail(mails,folderId,this.onSuccessMoveMailToFolder.bind(this));},onSuccessMoveMailToFolder:function(status,param){if(status<0){if(status==-2){ammsg.error('RMAIL0602');}else if(param.errorStatus=='permission'){ammsg.error('RMAIL0601');}else{ammsg.error("RMAIL0600");}}
if(param.unseenUpdate){amtop.infoUpdater.stopUpdateUnseen();mailFolder.updateUnseenDiffCtrl(param.unseenUpdate);}},moveMail:function(mails,folderId,onSuccess,onFailure){if(!mailFolder.isAccess(folderId)){ammsg.error("RMAIL0260");(onFailure||Prototype.emptyFunction)();return;}
var tgtFolder=mailFolder.getFolderHash(folderId);if(!this.checkMovable(mails,tgtFolder)){ammsg.error("RMAIL0170");(onFailure||Prototype.emptyFunction)();return;}
mailCommonRequest.moveMail(mails,tgtFolder,onSuccess,onFailure);},copyMailToFolder:function(folderId){var mails=mailList.getSelectedMails();if(!mails||(mails.length==0)){ammsg.error("RMAIL0140");return;}
this.copyMail(mails,folderId,this.onSuccessCopyMailToFolder.bind(this));},onSuccessCopyMailToFolder:function(status,param){if(status<0){if(param.errorStatus=='permission'){ammsg.error('RMAIL0611');}else{ammsg.error("RMAIL0610");}}
if(param.unseenUpdate){amtop.infoUpdater.stopUpdateUnseen();mailFolder.updateUnseenDiffCtrl(param.unseenUpdate);}},copyMail:function(mails,folderId,onSuccess,onFailure){if(!mailFolder.isAccess(folderId)){ammsg.error("RMAIL0260");(onFailure||Prototype.emptyFunction)();return;}
var tgtFolder=mailFolder.getFolderHash(folderId);if(!this.checkMovable(mails,tgtFolder)){ammsg.error("RMAIL0150");(onFailure||Prototype.emptyFunction)();return;}
mailCommonRequest.copyMail(mails,tgtFolder,onSuccess,onFailure);},furiwake:function(){mailList.furiwake();},moveSpam:function(){var mails=mailList.getSelectedMails();if(!mails||(mails.length==0)){ammsg.error("RMAIL0180");return;}
if(Object.evalAmBoolean(amdata.sys.DISP_JUNKMAIL))
{mailCommonRequest.moveSpam(mails,this.onSuccessMoveSpam.bind(this));}},onSuccessMoveSpam:function(status,param){if(status<0){if(status==-2){ammsg.error("RMAIL0621");}else{ammsg.error("RMAIL0620");}}
if(param.unseenUpdate){amtop.infoUpdater.stopUpdateUnseen();mailFolder.updateUnseenDiffCtrl(param.unseenUpdate);}},setUnseen:function(){var mails=mailList.getSelectedMails();if(!mails||(mails.length==0)){ammsg.error("RMAIL0200");return;}
mailCommonRequest.setUnseen(mails);},setSeenSelectedRow:function(){if(mailLock.locked){window.setTimeout(function(){mailControl.setSeenSelectedRow();},100);return;}
var id=mailList.getFocusedRow();var mails=[{uid:mailList.list.getUserData(id,"uid"),folder:mailList.list.getUserData(id,"folder")}];if(!mails||(mails.length==0)){ammsg.error("RMAIL0210");return;}
mailCommonRequest.setSeen(mails);},setSeen:function(){var mails=mailList.getSelectedMails();if(!mails||(mails.length==0)){ammsg.error("RMAIL0210");return;}
mailCommonRequest.setSeen(mails);},setFlag:function(){var mails=mailList.getSelectedMails();if(!mails||(mails.length==0)){ammsg.error("RMAIL0220");return;}
mailCommonRequest.setFlag(mails);},unsetFlag:function(){var mails=mailList.getSelectedMails();if(!mails||(mails.length==0)){ammsg.error("RMAIL0230");return;}
mailCommonRequest.unsetFlag(mails);},moveTrash:function(){if(mailFolder.isTrash()){return;}
var mails=mailList.getSelectedMails();if(!mails||(mails.length==0)){ammsg.error("RMAIL0750");return;}
mailCommonRequest.moveTrash(mails,this.onSuccessMoveTrash.bind(this));},onSuccessMoveTrash:function(status,param){if(status<0){if(status==-2){ammsg.error("RMAIL0631");}else{ammsg.error("RMAIL0630");}}
if(param.unseenUpdate){amtop.infoUpdater.stopUpdateUnseen();mailFolder.updateUnseenDiffCtrl(param.unseenUpdate);}},confirmDeleteMail:function(){var mails=mailList.getSelectedMails();if(!mails||(mails.length==0)){ammsg.error("RMAIL0120");return;}
this.deleteMails=mails;if(mailFolder.getCurrentFolder()!=amdata.gen.PERSONAL_TRASH){mailList.saveScrollTop();mailList.saveSelectRowIndexes();mailList.saveFocusIndex();ammsg.confirm("RMAIL0250",null,this.deleteMail.bind(this));}else{mailList.saveScrollTop();mailList.saveSelectRowIndexes();mailList.saveFocusIndex();this.deleteMail(1);}},deleteMail:function(status){if(status==1){mailCommonRequest.deleteMail(this.deleteMails,this.onSuccessDeleteMail.bind(this),Prototype.F,true);}else{mailList.clearScrollTop();mailList.clearSelectRow();mailList.clearFocus();}},onSuccessDeleteMail:function(status,param){if(status<0){if(status==-2){ammsg.error("RMAIL0351");}}},getTrashInfo:function(){mailCommonRequest.getTrashInfo(this.confirmClearTrash.bind(this));},confirmClearTrash:function(status,param){var trashUnseen=parseInt(param.trashUnseen);var trashTotal=parseInt(param.trashTotal);ammsg.confirm("RMAIL0070",{$unseennum:trashUnseen,$mailnum:trashTotal},this.clearTrash.bind(this));},clearTrash:function(status){if(status==1){mailCommonRequest.clearTrash(this.onSuccessClearTrash.bind(this));}},onSuccessClearTrash:function(status,param){ammsg.info("RMAIL0340");if(param.unseenUpdate){amtop.infoUpdater.stopUpdateUnseen();mailFolder.updateUnseenDiffCtrl(param.unseenUpdate);}},getPop:function(){this.setReqFirst(true);mailCommonRequest.getPop(this.onSuccessGetPop.bind(this));},onSuccessGetPop:function(status,param){if(amdata.sys.EXTRA_POP_DISPLAY_MESSAGE=="on"){var num=parseInt(param.popCount);var result=param.popResults;this.displayPopResult(num,result,false);}
if(param.unseenUpdate){amtop.infoUpdater.stopUpdateUnseen();mailFolder.updateUnseenDiffCtrl(param.unseenUpdate);}},displayPopResult:function(num,result,onlyError){var errorCount=0;var remaining=false;var len=result.getRecordNum();var msg=new Array();for(var i=0;i<len;i++){msg.push("["+result.getValue(i,"ACCOUNT_NAME").escapeHTML()+"] ");var status=result.getValue(i,"ERROR_STATUS");var statusMsg=this.popMessages[status]||this.popMessages["other_error"];statusMsg=statusMsg.replace(/\$num/,result.getValue(i,"RECEIVED_NUMBER"));if((status!="success")&&(status!="pop_no_newmail")){errorCount++;if((status=="pop_not_all")||(status=="pop_size")){remaining=true;}}
msg.push(statusMsg);msg.push("<br />");}
if(!onlyError||(errorCount>0)){ammsg.info((remaining)?"RMAIL0361":"RMAIL0360",{$result:msg.join(""),$count:num});}},displayAdminPopResult:function(result){var errorCount=0;var remaining=false;var msg=new Array();var current=0;var status=result.getValue(current,"ERROR_STATUS");var statusMsg=this.popMessages[status]||this.popMessages["other_error"];statusMsg=statusMsg.replace(/\$num/,result.getValue(current,"RECEIVED_NUMBER"));if((status!="success")&&(status!="pop_no_newmail")){errorCount++;if((status=="pop_not_all")||(status=="pop_size")){remaining=true;}}
msg.push(statusMsg);msg.push("<br />");if(errorCount>0){ammsg.info((remaining)?"RMAIL0363":"RMAIL0362",{$result:msg.join("")});}},reload:function(){this.setReqFirst(true);mailList.loadList(false);},reply:function(){if(mailFolder.isDraft()){return;}
var mails=mailList.getSelectedMails();if(!mails||(mails.length==0)){ammsg.error("RMAIL0130");return;}
mailCommonRequest.composeReply(mails);},replyAll:function(){if(mailFolder.isDraft()){return;}
var mails=mailList.getSelectedMails();if(!mails||(mails.length==0)){ammsg.error("RMAIL0130");return;}
mailCommonRequest.composeReplyAll(mails);},forward:function(){if(mailFolder.isDraft()){return;}
var mails=mailList.getSelectedMails();if(!mails||(mails.length==0)){ammsg.error("RMAIL0190");return;}
mailCommonRequest.composeForward(mails);},smail:function(){amtop.changeContents('smail');},filter:function(){mailList.loadList(true);},getFilterCondition:function(){return this.elFilter.value;},getReqFirst:function(){var ret=Boolean(this.reqFirst);this.reqFirst=false;return ret;},setReqFirst:function(fl){this.reqFirst=Boolean(fl);},changeStatus:function(){var folder=mailFolder.getCurrentFolder();if(folder==amdata.gen.PERSONAL_DRAFTS){if(this.items.reply){this.items.reply.disable();}
if(this.items.replyAll){this.items.replyAll.disable();}
if(this.items.forward){this.items.forward.disable();}}else{if(this.items.reply){this.items.reply.enable();}
if(this.items.replyAll){this.items.replyAll.enable();}
if(this.items.forward){this.items.forward.enable();}}
if(folder==amdata.gen.PERSONAL_TRASH){if(this.items.trash){this.items.trash.disable();}}else{if(this.items.trash){this.items.trash.enable();}}
if(mailFolder.isSharedFolder(mailFolder.currentID)){if(this.items.furiwake){this.items.furiwake.disable();}}else{if(this.items.furiwake){this.items.furiwake.enable();}}
if(Object.evalAmBoolean(amdata.sys.DISP_JUNKMAIL))
{if(folder==amdata.gen.PERSONAL_JUNKMAIL){if(this.items.spam){this.items.spam.disable();}}else{if(this.items.spam){this.items.spam.enable();}}}}});MailViewer=Class.create({elTop:null,elUpdater:null,classParent:"_switch_parent",classTarget:"_switch_target",classControl:"_switch_control",classExpand:"_switch_expand",classCollapse:"_switch_collapse",emptyContents:null,headerExpanded:false,folder:null,uid:null,subject:null,mdnRecipient:null,lastSwitchStatus:false,pulldown:null,locked:false,opened:false,initialize:function(idUpdater,idTop,idOriginalMenu,idMenu){this.elUpdater=$(idUpdater);this.elTop=$(idTop);this.emptyContents=this.elTop.innerHTML;if(idOriginalMenu){var menu=new am.PulldownMenu(idOriginalMenu);}
this.idMenu=idMenu;if(amdata.usr.MAILHEADER_DETAIL=="open"){this.headerExpanded=true;}},lock:function(){if(this.pulldown){this.pulldown.disable();}
this.locked=true;},unlock:function(){if(this.pulldown){this.pulldown.enable();}
this.locked=false;},cleanUp:function(){if(this.pulldown){this.pulldown.destroy();this.pulldown=null;}},isHeaderExpanded:function(){return this.headerExpanded;},setup:function(enableMenu,folder,uid,subject,isDraft,isDraftOrSent,mdnRecipient){this.folder=folder;this.uid=uid;this.subject=subject;if(enableMenu){var option={clone:true};this.pulldown=new am.PulldownMenu(this.idMenu,option);if(isDraft){this.pulldown.hidden("pulldown_mail_preview_reply");this.pulldown.hidden("pulldown_mail_preview_replyall");this.pulldown.hidden("pulldown_mail_preview_forward_ref");this.pulldown.hidden("pulldown_mail_preview_forward_att");}
if(!isDraftOrSent){this.pulldown.hidden("pulldown_mail_preview_reedit");}}
if(mdnRecipient){this.confirmMdn(mdnRecipient);}
this.opened=true;},update:function(content){this.cleanUp();this.elTop.scrollTop=0;this.elTop.innerHTML=content;var f=document.forms.mail_viewer_parameters;var enableMenu=!!(f.enable_menu);var folder=(f.folder_hash)?f.folder_hash.value:"";var uid=(f.uid)?f.uid.value:"";var subject=(f.subject)?f.subject.value:"";var isDraft=!!(f.is_draft);var isDraftOrSent=!!(f.is_draft_or_sent);var mdnRecipient=(f.mdn_recipient)?f.mdn_recipient.value:"";this.setup(enableMenu,folder,uid,subject,isDraft,isDraftOrSent,mdnRecipient);if(!mailLayout.visible('view')){mailLayout.hide('list');mailList.setInactive();}},close:function(){this.cleanUp();this.folder=null,this.uid=null;this.elTop.innerHTML=this.emptyContents;this.opened=false;if(!mailLayout.visible('list')){mailLayout.close('view');mailList.setActive();}},isOpened:function(){return this.opened;},confirmMdn:function(recipient){this.mdnRecipient=recipient;ammsg.confirm("RMAIL0590",null,this.sendMdn.bind(this));},sendMdn:function(status){if(status==1){mailCommonRequest.sendMdn(this.folder,this.uid,this.mdnRecipient);}
this.mdnRecipient=null;},compose:function(recipient){if(this.locked)return;amtop.compose(recipient);},addAddress:function(name,mailbox,host){if(this.locked)return;var win=amvpop.openModalWindow(rmailAddressFormSource,rmailAddressFormTitle,400,247);var f=win.getForm("rmail_add_address_form");f.furigana.value="";f.dispname.value=name.decodeURI();if(0<mailbox.length&&0<host.length){f.email.value=mailbox.decodeURI()+"@"+host.decodeURI();}else{f.email.value=mailbox.decodeURI()+host.decodeURI();}},checkAddress:function(furigana,name,email){if(furigana.wblank()||name.wblank()||email.wblank()){ammsg.statusError("RMAIL0300");return false;}else{return true;}},submitAddress:function(f){var furigana=f.furigana.value
var name=f.dispname.value;var email=f.email.value;var pathindex=f.paddr_path_index.value;if(!this.checkAddress(furigana,name,email)){return;}
if(this.addrsubmit_lock){return;}else{this.addrsubmit_lock=true;}
var uri=amdata.url.bin+"amaddr";var opt={};opt.method="post";opt.parameters=$H({actid:"addr_from_rmail",id:amdata.session.ID,ajax:"on",name:name,email:email,addrpath:pathindex,hurigana:furigana}).toQueryString();opt.asynchronous=true;opt.evalScripts=true;opt.onFailure=this.onFailureSubmitAddress.bind(this);var req=new Ajax.Updater(this.elUpdater,uri,opt);},onSuccessSubmitAddress:function(status){var put_error=function(str){ammsg.statusError(str);this.addrsubmit_lock=false;}.bind(this);switch(status){case"addr_success":this.onCompleteSubmitAddress();break;case"no_email":put_error('RMAIL0440');break;case"wrong_email":put_error('RMAIL0450');break;case"same_email":put_error('RMAIL0460');break;case"no_name":put_error('RMAIL0470');break;case"no_hurigana":put_error('RMAIL0490');break;case"same_name_group":put_error('RMAIL0500');break;case"wrong_name":put_error('RMAIL0550');break;case"unknown_email":put_error('RMAIL0480');break;default:put_error('RMAIL0480');break;}},onCompleteSubmitAddress:function(){amvpop.closeWindow();ammsg.info("RMAIL0430");this.addrsubmit_lock=false;},onFailureSubmitAddress:function(request,header){ammsg.statusError("RMAIL0270");this.addrsubmit_lock=false;},cancelAddress:function(){amvpop.closeWindow();},_download_lock:false,download:function(part,name){if(this._download_lock){return;}else{this._download_lock=true;}
var param={folder:this.folder,uid:this.uid,part:part};amtop.download(amdata.url.bin+"ammain","rmail_download_attach",param,name.decodeURI(),this.onFailureDownload);this.downloadUnlock.bind(this).delay(3);},downloadUnlock:function(){this._download_lock=false;},downloadMail:function(action,ext){var name=(this.subject||"no_name")+ext;var param={folder:this.folder,uid:this.uid};amtop.download(amdata.url.bin+"ammain",action,param,name,this.onFailureDownload);},onFailureDownload:function(status){ammsg.error("GENERAL0070",{$errcode:status});},_findElementByClassName:function(el,name){while(el&&(el!=window.document)){if(Element.hasClassName(el,name)){return $(el);}
el=el.parentNode;}
return null;},selectChildren:function(element,className){return $$("##{id} > .#{className}".interpolate({id:element.identify(),className:className}));},switchDisplay:function(ev){var el=Event.element(ev);var _top=this._findElementByClassName(el,this.classParent);var _control=this._findElementByClassName(el,this.classControl);if(!_top||!_control)return;var _expand=this.selectChildren(_control,this.classExpand).first();var _collapse=this.selectChildren(_control,this.classCollapse).first();if(!_expand||!_collapse)return;if(_expand.visible()){_expand.hide();_collapse.show();this.lastSwitchStatus=true;}else{_expand.show();_collapse.hide();this.lastSwitchStatus=false;}
this.selectChildren(_top,this.classTarget).invoke("toggle");if(is.safari){_top.style.width=_top.clientWidth-1;_top.style.width=_top.clientWidth+1;_top.style.width="";}},switchDisplayHeader:function(ev){this.switchDisplay.apply(this,arguments);this.headerExpanded=this.lastSwitchStatus;},getMailInfo:function(){var info=new Array();info.push({folder:this.folder,uid:this.uid});return info;},onSelectAction:function(action){if(this.locked)return;switch(action){case"download_source":this.downloadMail("rmail_download_source",".eml");break;case"download_text":this.downloadMail("rmail_download_text",".txt");break;case"print":mailViewRequest.popupPrintMail(this.folder,this.uid);break;case"view_source":mailViewRequest.popupMailSource(this.folder,this.uid);break;case"reedit":mailCommonRequest.composeReEdit(this.getMailInfo());break;case"forward":mailCommonRequest.composeForward(this.getMailInfo());break;case"forward_ref":mailCommonRequest.composeForwardRef(this.getMailInfo());break;case"forward_att":mailCommonRequest.composeForwardAtt(this.getMailInfo());break;case"reply":mailCommonRequest.composeReply(this.getMailInfo());break;case"replyall":mailCommonRequest.composeReplyAll(this.getMailInfo());break;default:break;}},previousMail:function(){if(this.locked)return;mailList.selectPreviousRow();},nextMail:function(){if(this.locked)return;mailList.selectNextRow();},popup:function(folder,uid){folder=folder||this.folder;uid=uid||this.uid;mailViewRequest.popupReadMail(folder,uid);},popupFromKeybord:function(folder,uid){folder=folder||this.folder;uid=uid||this.uid;mailViewRequest.popupReadMailFromShortcut(folder,uid);},popupHtml:function(folder,uid,part){folder=folder||this.folder;uid=uid||this.uid;mailViewRequest.popupHtmlMail(folder,uid,part);},popupText:function(folder,uid,part){folder=folder||this.folder;uid=uid||this.uid;mailViewRequest.popupTextMail(folder,uid,part);},withImageHtml:function(folder,uid){folder=folder||this.folder;uid=uid||this.uid;mailList.withImageHtml(folder,uid);},popupAmSystemMdn:function(folder,uid){folder=folder||this.folder;uid=uid||this.uid;mailViewRequest.popupAmSystemMdn(folder,uid);}});PopupMailViewer=Class.create(MailViewer,{nameForm:null,initialize:function($super,idUpdater,idTop,idOriginalMenu,idMenu,nameForm){$super(idUpdater,idTop,idOriginalMenu,idMenu);this.nameForm=nameForm;},setup:function($super,enableMenu){var f=document.forms.mail_viewer_parameters;var folder=(f.folder_hash)?f.folder_hash.value:"";var uid=(f.uid)?f.uid.value:"";var subject=(f.subject)?f.subject.value:"";var isDraft=!!(f.is_draft);var isDraftOrSent=!!(f.is_draft_or_sent);var mdnRecipient=(f.mdn_recipient)?f.mdn_recipient.value:"";$super(enableMenu,folder,uid,subject,isDraft,isDraftOrSent,mdnRecipient);},_download_lock:false,download:function(part,name){if(this._download_lock){return;}else{this._download_lock=true;}
var f=document.forms[this.nameForm];var param={folder:this.folder,uid:this.uid,part:part};amtop.setAjaxRequestForm(document,f,amdata.url.bin+"ammain","rmail_download_attach",param,name.decodeURI());f.submit();this.downloadUnlock.bind(this).delay(3);},downloadUnlock:function(){this._download_lock=false;},downloadMail:function(action,ext){var uri=amdata.url.bin+"ammain";var param={folder:this.folder,uid:this.uid};var filename=(this.subject||"no_name")+ext;var f=document.forms["fileDownloadForm"];amtop.setAjaxRequestForm(document,f,uri,action,param,filename);f.target="fileDownloadFrame";f.method="post";amtop.onFailureAjaxDownload=this.onFailureDownload;f.submit();}});if(typeof(GridContextMenu)!="undefined"){var RmailGridContextMenu=Class.create(GridContextMenu,{show:function($super,id,index,e){if(mailFolder.isTrash()){this.switchItem.curLevel=1;}else if(mailFolder.isDraft()){this.switchItem.curLevel=2;}else{this.switchItem.curLevel=0;}
$super(id,index,e);}});}
if(typeof(TreeContextMenu)!="undefined"){var RmailTreeContextMenu=Class.create(TreeContextMenu,{_show:function($super,id,e){if(id=="shared"){return false;}
return $super(id,e);}});}
if(typeof(dhtmlXTreeObject)!="undefined"){Object.extend(dhtmlXTreeObject.prototype,{_globalIdStorageFind:function(itemId,skipXMLSearch,skipParsing,isreparse){var z=this._idpull[itemId]
if(z){if((z.unParsed)&&(!skipParsing)){this._reparse=1;this.reParse(z,0);this._reparse=0;}
if(this._srnd&&!z.htmlNode)
this._buildSRND(z,skipParsing);if((isreparse)&&(this._edsbpsA)){for(var j=0;j<this._edsbpsA.length;j++)
if(this._edsbpsA[j][2]==itemId){dhtmlxError.throwError("getItem","Requested item still in parsing process.",itemId);return null;}}
return z;}
if((this.slowParse)&&(itemId!=0)&&(!skipXMLSearch))
return this.preParse(itemId);else
return null;},_parse:function(p,parentId,level,start){if(this._srnd&&!this.parentObject.offsetHeight){var self=this;return window.setTimeout(function(){self._parse(p,parentId,level,start);},100);}
if(!p.exists())return;this.skipLock=true;this.parsCount=this.parsCount?(this.parsCount+1):1;this.XMLloadingWarning=1;this.nodeAskingCall="";if(!parentId){parentId=p.get("id");if(p.get("radio"))
this.htmlNode._r_logic=true;this.parsingOn=parentId;this.parsedArray=new Array();this.setCheckList="";}
var temp=this._globalIdStorageFind(parentId);if(!temp)return dhtmlxError.throwError("DataStructure","XML reffers to not existing parent");if((temp.childsCount)&&(!start)&&(!this._edsbps)&&(!temp._has_top))
var preNode=temp.childNodes[temp.childsCount-1];else
var preNode=0;this.npl=0;p.each("item",function(c,i){temp.XMLload=1;if((this._epgps)&&(this._epgpsC==this.npl)){this._setNextPageSign(temp,this.npl+1*(start||0),level,node);return-1;}
this._parseItem(c,temp,preNode);if((this._edsbps)&&(this.npl==this._edsbpsC)){this._distributedStart(p,i+1,parentId,level,temp.childsCount);return-1;}
this.npl++;},this,start);if(!level){p.each("userdata",function(u){this.setUserData(p.get("id"),u.get("name"),u.content());},this);temp.XMLload=1;if(this.waitUpdateXML){this.waitUpdateXML=false;for(var i=temp.childsCount-1;i>=0;i--)
if(temp.childNodes[i]._dmark)
this.deleteItem(temp.childNodes[i].id);}
var parsedNodeTop=this._globalIdStorageFind(this.parsingOn);for(var i=0;i<this.parsedArray.length;i++)
temp.htmlNode.childNodes[0].appendChild(this.parsedArray[i]);this.lastLoadedXMLId=parentId;this.XMLloadingWarning=0;var chArr=this.setCheckList.split(this.dlmtr);for(var n=0;n<chArr.length;n++)
if(chArr[n])this.setCheck(chArr[n],1);if((this.XMLsource)&&(this.tscheck)&&(this.smcheck)&&(temp.id!=this.rootId)){if(temp.checkstate===0)
this._setSubChecked(0,temp);else if(temp.checkstate===1)
this._setSubChecked(1,temp);}
if(this.onXLE)
this.onXLE(this,parentId);this._redrawFrom(this,null,start)
if(p.get("order")&&p.get("order")!="none")
this._reorderBranch(temp,p.get("order"),true);if(this.nodeAskingCall!="")
this.selectItem(this.nodeAskingCall,true);if(this._branchUpdate)
this._branchUpdateNext(p);}
if(this.parsCount==1){if((this.slowParse)&&(this.parsingOn==this.rootId))
p.through("item","open",null,function(c){this.openItem(c.get("id"));},this);this.parsingOn=null;if((!this._edsbps)||(!this._edsbpsA.length)){var that=this;if(!this._reparse){window.setTimeout(function(){that.callEvent("onXLE",[that,parentId]);},1);}
this.xmlstate=0;}
this.skipLock=false;}
this.parsCount--;var that=this;if(this._edsbps)
window.setTimeout(function(){that._distributedStep(parentId);},this._edsbpsD);if((this._epgps)&&(start))
this._setPrevPageSign(temp,(start||0),level,node);return this.nodeAskingCall;}});}
