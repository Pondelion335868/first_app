am.Layout={};am.Layout.Slider=Class.create(am.Drag.Driver,{initialize:function($super,param){$super(param);this.slider=(new Element('div')).hide();this.handle.parentNode.appendChild(this.slider);this.slider.addClassName(param.cls_slider);this.slider.setStyle({position:'absolute',top:0,left:0});},destroy:function($super){this.slider.remove();delete this.slider;$super();},ready:function(element,x,y){this.slider.setStyle({top:element.style.top,left:element.style.left,width:element.style.width,height:element.style.height});this.slider.show();this.fire('amlayout:slidestart',this.slider);return true;},process:function(element,x,y,deltaX,deltaY){this.fire('amlayout:slide',this.slider,deltaX,deltaY);},finish:function(element,x,y){this.fire('amlayout:slideend',this.slider);this.slider.hide();}});am.Layout.Region=Class.create(am.Observable,{initialize:function(param){this.id=param.id;if(param.element){this.element=$(param.element);if(this.element.parentNode!==param.parent_element){param.parent_element.appendChild(this.element.remove());}
this.element.setStyle({position:'absolute',top:0,left:0});this.element.prepareBoxMethods();}
this.size=param.size;this.autosized=(this.size==null);this.minimum=param.minimum;this.maximum=param.maximum;if(this.autosized){this.resizable=false;}else{this.resizable=(param.resizable==null)?true:!!param.resizable;}
this.closable=!!param.closable;this.observe(param.listeners);},destroy:function(){this.stopObserving();delete this.element;},isSavable:function(){if((typeof(this.dump)==='function')&&(typeof(this.restore)==='function')){return!!this.savable;}
return false;},isAutoSized:function(){return this.autosized;},getSize:function(){return this.size;},setSize:function(size){this.size=size;},show:function(){this.element.show();},hide:function(){this.element.hide();},visible:function(){return this.element.visible();},getTop:function(){return this.element?this.element.offsetTop:this.top;},setTop:function(top){if(this.element){this.element.style.top=top+'px';}else{this.top=top;}},getLeft:function(){return this.element?this.element.offsetLeft:this.left;},setLeft:function(left){if(this.element){this.element.style.left=left+'px';}else{this.left=left;}},getWidth:function(){if(!this.visible()){return 0;}
return this.element?this.element.getBorderBoxWidth():this.width;},setWidth:function(width){if(this.element){this.element.setBorderBoxWidth(width);}else{this.width=width;}},getHeight:function(){if(!this.visible()){return 0;}
return this.element?this.element.getBorderBoxHeight():this.height;},setHeight:function(height){if(this.element){this.element.setBorderBoxHeight(height);}else{this.height=height;}},getRange:function(current){return[isNaN(this.minimum)?Number.NEGATIVE_INFINITY:this.minimum-current,isNaN(this.maximum)?Number.POSITIVE_INFINITY:this.maximum-current];},adjust:Prototype.K,setRect:function(top,left,width,height){if(top!=null){this.setTop(top);}
if(left!=null){this.setLeft(left);}
if(width!=null){this.setWidth(width);}
if(height!=null){this.setHeight(height);}
this.adjust();},transform:function(top,left,width,height){if(top!==0){this.setTop(this.getTop()+top);}
if(left!==0){this.setLeft(this.getLeft()+left);}
if(width!==0){this.setWidth(this.getWidth()+width);}
if(height!==0){this.setHeight(this.getHeight()+height);}
this.adjust();}});am.Layout.SplitBar=Class.create(am.Layout.Region,{initialize:function(param){this.element=param.parent_element.appendChild(new Element('div'));this.element.addClassName(param.cls_prefix+this.cls_base);this.element.setStyle({position:'absolute',top:0,left:0});this.element.prepareBoxMethods();this.autosized=true;this.parent=param.parent;this.prev=param.prev;this.next=param.next;if(this.prev.resizable&&this.next.resizable){this.slider=new am.Layout.Slider({handle:this.element,cls_slider:param.cls_prefix+this.cls_slider,listeners:{'amlayout:slidestart':this.onSlideStart.bind(this),'amlayout:slide':this.onSlide.bind(this),'amlayout:slideend':this.onSlideEnd.bind(this)}});this.cls_enabled=param.cls_prefix+this.cls_enabled;this.element.addClassName(this.cls_enabled);}
if(this.prev.closable){this.close_prev=this.element.appendChild(new Element('div'));this.close_prev.addClassName(param.cls_prefix+this.cls_close_prev);this.close_prev.observe('mousedown',Event.stop);this.close_prev.observe('click',this.close.bind(this,true));this.open_prev=this.element.appendChild(new Element('div')).hide();this.open_prev.addClassName(param.cls_prefix+this.cls_open_prev);this.open_prev.observe('mousedown',Event.stop);this.open_prev.observe('click',this.open.bind(this));}
if(this.next.closable){this.close_next=this.element.appendChild(new Element('div'));this.close_next.addClassName(param.cls_prefix+this.cls_close_next);this.close_next.observe('mousedown',Event.stop);this.close_next.observe('click',this.close.bind(this,false));this.open_next=this.element.appendChild(new Element('div')).hide();this.open_next.addClassName(param.cls_prefix+this.cls_open_next);this.open_next.observe('mousedown',Event.stop);this.open_next.observe('click',this.open.bind(this));}},destroy:function(){this.stopObserving();if(this.slider){this.slider.destory();delete this.slider;}
if(this.close_prev){this.close_prev.stopObserving().remove();delete this.close_prev;}
if(this.open_prev){this.open_prev.stopObserving().remove();delete this.open_prev;}
if(this.close_next){this.close_next.stopObserving().remove();delete this.close_next;}
if(this.open_next){this.open_next.stopObserving().remove();delete this.open_next;}
this.element.remove();delete this.element;delete this.parent;delete this.prev;delete this.next;},enable:function(){if(this.slider){this.slider.enable();this.element.addClassName(this.cls_enabled);}},disable:function(){if(this.slider){this.slider.disable();this.element.removeClassName(this.cls_enabled);}},close:function(direction){this.parent.close(this.prev,this.next,direction);},open:function(){this.parent.open(this.prev,this.next);},adjust:function(){var buttons=['close_prev','close_next','open_prev','open_next'];var prev_visible=this.prev.visible();var next_visible=this.next.visible();if(prev_visible&&next_visible){var visibilities=[true,true,false,false];this.enable();}else{this.disable();if(!prev_visible&&next_visible){var visibilities=[false,false,true,false];}else if(prev_visible&&!next_visible){var visibilities=[false,false,false,true];}else{var visibilities=[false,false,false,false];}}
for(var i=0,len=buttons.length;i<len;i++){var button=this[buttons[i]];if(button){if(visibilities[i]){button.show();}else{button.hide();}}}}});am.Layout.VerticalSplitBar=Class.create(am.Layout.SplitBar,{cls_base:'vertical_split_bar',cls_enabled:'vertical_split_bar_enabled',cls_slider:'vertical_slider',cls_open_prev:'open_north',cls_open_next:'open_south',cls_close_prev:'close_north',cls_close_next:'close_south',onSlideStart:function(){var prev_range=this.prev.getRange(this.prev.getHeight());var next_range=this.next.getRange(this.next.getHeight());this.minimum=Math.max(prev_range[0],-next_range[1]);this.maximum=Math.min(prev_range[1],-next_range[0]);},onSlide:function(slider,deltaX,deltaY){deltaY=Math.min(Math.max(deltaY,this.minimum),this.maximum);slider.style.top=(this.getTop()+deltaY)+'px';},onSlideEnd:function(slider){var diff=slider.offsetTop-this.getTop();this.prev.transform(0,0,0,diff);this.transform(diff,0,0,0)
this.next.transform(diff,0,0,-diff);this.parent.recalc();}});am.Layout.HorizontalSplitBar=Class.create(am.Layout.SplitBar,{cls_base:'horizontal_split_bar',cls_enabled:'horizontal_split_bar_enabled',cls_slider:'horizontal_slider',cls_open_prev:'open_west',cls_open_next:'open_east',cls_close_prev:'close_west',cls_close_next:'close_east',onSlideStart:function(){var prev_range=this.prev.getRange(this.prev.getWidth());var next_range=this.next.getRange(this.next.getWidth());this.minimum=Math.max(prev_range[0],-next_range[1]);this.maximum=Math.min(prev_range[1],-next_range[0]);},onSlide:function(slider,deltaX,deltaY){deltaX=Math.min(Math.max(deltaX,this.minimum),this.maximum);slider.style.left=(this.getLeft()+deltaX)+'px';},onSlideEnd:function(slider){var diff=slider.offsetLeft-this.getLeft();this.prev.transform(0,0,diff,0);this.transform(0,diff,0,0)
this.next.transform(0,diff,-diff,0);this.parent.recalc();}});am.Layout.SplitRegion=Class.create(am.Layout.Region,{initialize:function($super,param){$super(param);this.items=[];var previous_item;param.items.each(function(item){if(previous_item){this.items.push(new this.split_bar({parent_element:param.parent_element,cls_prefix:param.cls_prefix,parent:this,prev:previous_item,next:item}));}
this.items.push(item);if(!item.isAutoSized()){this.regulator=item;}
previous_item=item;},this);this.savable=!param.no_save;},destroy:function($super){this.items.invoke('destroy');delete this.items;$super();},show:function(){if(!this.hidden){return;}
this.hidden_items.invoke('show');delete this.hidden_items;this.hidden=false;},hide:function(){if(this.hidden){return;}
this.hidden_items=[];this.items.each(function(item){if(item.visible()){item.hide();this.hidden_items.push(item);}},this);this.hidden=true;},visible:function(){return!this.hidden;},getFreeWidth:function(){var width=this.getWidth();this.items.each(function(item){if(item.isAutoSized()){width-=item.getWidth();}});return width;},getFreeHeight:function(){var height=this.getHeight();this.items.each(function(item){if(item.isAutoSized()){height-=item.getHeight();}});return height;},getBar:function(above,below){var index=(this.items.indexOf(above)+this.items.indexOf(below))/2;return this.items[index];},getItemById:function(id){for(var i=0,len=this.items.length;i<len;i++){var item=this.items[i];if(item.id===id){return item;}
if(item.getItemById){item=item.getItemById(id);if(item){return item;}}}
return null;},dump:function(){return this.items.map(function(item){var status=(item.visible()?'1':'0');status+='c';status+=(item.getSize()||0).toString().truncate(5,'');if(item.isSavable()){status+='x'+item.dump();}
return status;}).join('x');},restore:function(status){this.items.each(function(item){var state=status.shift().split('c');if(state[0]==='1'){item.show();}else{item.hide();}
item.setSize(parseFloat(state[1]));if(item.isSavable()){item.restore(status);}});}});am.Layout.VerticalSplitRegion=Class.create(am.Layout.SplitRegion,{split_bar:am.Layout.VerticalSplitBar,close:function(above,below,direction,hidden){if(!above.visible()||!below.visible()){return;}
var bar=this.getBar(above,below);var top=above.getTop();var left=above.getLeft();var width=bar.getWidth();var above_height=above.getHeight();var below_height=below.getHeight();var bar_height=bar.getHeight();var height=above_height+below_height;if(direction){above.hide();above.setSize(above_height/height*100.0);if(hidden){height+=bar_height;bar.hide();}else{bar.setRect(top,left,width,null);top+=bar_height;}
below.setRect(top,left,width,height);}else{below.hide();below.setSize(below_height/height*100.0);if(hidden){height+=bar_height;bar.hide();}else{bar.setRect(top+height,left,width,null);}
above.setRect(top,left,width,height);}
this.recalc();},open:function(above,below){var above_visible=above.visible();var below_visible=below.visible();if(above_visible&&below_visible){return;}
if(!above_visible&&!below_visible){return;}
var bar=this.getBar(above,below);var bar_visible=bar.visible();bar.show();if(!above_visible){if(bar_visible){var top=bar.getTop();var left=bar.getLeft();var height=below.getHeight();}else{var top=below.getTop();var left=below.getLeft();var height=below.getHeight()-bar.getHeight();}
var above_height=Math.round(height*above.getSize()/100.0);var below_height=height-above_height;above.show();}else{var top=above.getTop();var left=above.getLeft();if(bar_visible){var height=above.getHeight();}else{var height=above.getHeight()-bar.getHeight();}
var below_height=Math.round(height*below.getSize()/100.0);var above_height=height-below_height;below.show();}
var width=bar.getWidth();above.setRect(top,left,width,above_height);top+=above_height;bar.setRect(top,left,width,null);top+=bar.getHeight();below.setRect(top,left,width,below_height);this.recalc();},adjust:function(){var width=this.getWidth();this.items.each(function(item){item.setWidth(width);});var height=this.getFreeHeight();var remain_height=height;this.items.each(function(item){if(!item.isAutoSized()&&item.visible()&&(item!==this.regulator)){var item_height=Math.round(height*item.getSize()/100.0);item.setHeight(item_height);remain_height-=item_height;}},this);if(this.regulator){this.regulator.setHeight(remain_height);}
var top=this.getTop();var left=this.getLeft();this.items.each(function(item){item.setRect(top,left);top+=item.getHeight();});},recalc:function(){var height=this.getFreeHeight();this.items.each(function(item){if(!item.isAutoSized()&&item.visible()){item.setSize(item.getHeight()/height*100.0);}});this.fire('amlayout:recalc',this.id);}});am.Layout.HorizontalSplitRegion=Class.create(am.Layout.SplitRegion,{split_bar:am.Layout.HorizontalSplitBar,close:function(above,below,direction,hidden){if(!above.visible()||!below.visible()){return;}
var bar=this.getBar(above,below);var top=above.getTop();var left=above.getLeft();var above_width=above.getWidth();var below_width=below.getWidth();var bar_width=bar.getWidth();var width=above_width+below_width;var height=bar.getHeight();if(direction){above.hide();above.setSize(above_width/width*100.0);if(hidden){width+=bar_width;bar.hide();}else{bar.setRect(top,left,null,height);left+=bar_width;}
below.setRect(top,left,width,height);}else{below.hide();below.setSize(below_width/width*100.0);if(hidden){width+=bar_width;bar.hide();}else{bar.setRect(top,left+width,null,height);}
above.setRect(top,left,width,height);}
this.recalc();},open:function(above,below){var above_visible=above.visible();var below_visible=below.visible();if(above_visible&&below_visible){return;}
if(!above_visible&&!below_visible){return;}
var bar=this.getBar(above,below);var bar_visible=bar.visible();bar.show();if(!above_visible){if(bar_visible){var top=bar.getTop();var left=bar.getLeft();var width=below.getWidth();}else{var top=below.getTop();var left=below.getLeft();var width=below.getWidth()-bar.getWidth();}
var above_width=Math.round(width*above.getSize()/100.0);var below_width=width-above_width;above.show();}else{var top=above.getTop();var left=above.getLeft();if(bar_visible){var width=above.getWidth();}else{var width=above.getWidth()-bar.getWidth();}
var below_width=Math.round(width*below.getSize()/100.0);var above_width=width-below_width;below.show();}
var height=bar.getHeight();above.setRect(top,left,above_width,height);left+=above_width;bar.setRect(top,left,null,height);left+=bar.getWidth();below.setRect(top,left,below_width,height);this.recalc();},adjust:function(){var height=this.getHeight();this.items.each(function(item){item.setHeight(height);});var width=this.getFreeWidth();var remain_width=width;this.items.each(function(item){if(!item.isAutoSized()&&item.visible()&&(item!==this.regulator)){var item_width=Math.round(width*item.getSize()/100.0);item.setWidth(item_width);remain_width-=item_width;}},this);if(this.regulator){this.regulator.setWidth(remain_width);}
var top=this.getTop();var left=this.getLeft();this.items.each(function(item){item.setRect(top,left);left+=item.getWidth();});},recalc:function(){var width=this.getFreeWidth();this.items.each(function(item){if(!item.isAutoSized()&&item.visible()){item.setSize(item.getWidth()/width*100.0);}});this.fire('amlayout:recalc',this.id);}});am.Layout.Builder=Class.create(am.Observable,{status_version:'2',cls_prefix:'amlayout_',initialize:function(param){this.container=$(param.container||document.body);this.container.makePositioned();this.container.prepareBoxMethods();this.listeners={'amlayout:recalc':this.onRecalc.bind(this)};this.layout=this.build({cls_prefix:param.cls_prefix,vertical:!!param.vertical,items:param.items});this.status_version=param.status_version||this.status_version;this.status_getter=param.status_getter;this.status_setter=param.status_setter;this.auto_load=!!param.auto_load;this.auto_save=!!param.auto_save;if(this.auto_load&&this.status_getter){this.restore(this.status_getter());}else{this.fit();}
if(this.auto_save&&this.status_setter){this.status_setter(this.dump());}
this.observe(param.listeners);},destroy:function(){this.stopObserving();this.layout.destroy();delete this.layout;},build:function(param){if(!param.cls_prefix){param.cls_prefix=this.cls_prefix;}
param.parent_element=this.container;if(!param.items){return new am.Layout.Region(param);}else{param.items=param.items.map(function(item){if(item.vertical==null){item.vertical=!param.vertical;}
return this.build(item);},this);param.listeners=this.listeners;if(param.vertical){return new am.Layout.VerticalSplitRegion(param);}else{return new am.Layout.HorizontalSplitRegion(param);}}},onRecalc:function(id){if(!this.silent){if(this.auto_save&&this.status_setter){this.status_setter(this.dump());}
this.fire('amlayout:resize',id);}},fit:function(id){if(id){this.layout.getItemById(id).adjust();}else{if(this.container===document.body){var width=amapp.getRenderWidth();var height=amapp.getRenderHeight();}else{var width=this.container.getContentBoxWidth();var height=this.container.getContentBoxHeight();}
this.layout.setRect(0,0,width,height);}
this.fire('amlayout:resize',id);},dump:function(){return this.status_version+'x'+this.layout.dump();},restore:function(status){status=(status||'').split('x');if(parseInt(status.shift())<=parseInt(this.status_version)){this.layout.restore(status);}
this.fit();}});am.Layout.Explorer=Class.create(am.Layout.Builder,{cls_prefix:'am_explorer_',initialize:function($super,param){var folder_item=param.items[0];var main_item=param.items[1];var list_item=main_item.items[0];var view_item=main_item.items[1];folder_item.id=this.folder_id=folder_item.id||'am_explorer_folder';main_item.id=this.main_id=main_item.id||'am_explorer_main';list_item.id=this.list_id=list_item.id||'am_explorer_list';view_item.id=this.view_id=view_item.id||'am_explorer_view';$super(param);},getRegions:function(name){if((name==='folder')||(name==='main')){var parent=this.layout;var above=this.layout.getItemById(this.folder_id);var below=this.layout.getItemById(this.main_id);}else if((name==='list')||(name==='view')){var parent=this.layout.getItemById(this.main_id);var above=this.layout.getItemById(this.list_id);var below=this.layout.getItemById(this.view_id);}
if((name=='folder')||(name==='list')){var direction=true;}else if((name==='main')||(name==='view')){var direction=false;}
return[parent,above,below,direction];},close:function(name){if(!this.visible(name)){return;}
var regions=this.getRegions(name);this.silent=true;regions[0].open(regions[1],regions[2]);this.silent=false;regions[0].close(regions[1],regions[2],regions[3]);},hide:function(name){if(!this.visible(name)){return;}
var regions=this.getRegions(name);this.silent=true;regions[0].open(regions[1],regions[2]);this.silent=false;regions[0].close(regions[1],regions[2],regions[3],true);},open:function(name){if(this.visible(name)){return;}
var regions=this.getRegions(name);regions[0].open(regions[1],regions[2]);},visible:function(name){switch(name){case'folder':return this.layout.getItemById(this.folder_id).visible();case'main':return this.layout.getItemById(this.main_id).visible();case'list':return this.layout.getItemById(this.list_id).visible();case'view':return this.layout.getItemById(this.view_id).visible();default:return false;}}});
