var YJAXC_STREAM_OI_HOSTNAME_DEFAULT="yjaxc.yahoo.co.jp";var YJAXC_STREAM_BEACON_ENTRY_DEFAULT="http://b94.yahoo.co.jp/gb.gif";var YjaxcStream=function(a){a=a||{};this.conf={dsName:window.yjaxc_stream_ds_name||"",typeTag:window.yjaxc_stream_bucket_id||"",oiHostName:a.oiHostName||YJAXC_STREAM_OI_HOSTNAME_DEFAULT,vbeacon:{enabled:!!(window.yjaxc_stream_enable_beacon),entry:a.vbeaconEntry||YJAXC_STREAM_BEACON_ENTRY_DEFAULT}};this.adUnits=[];this.takenCounter=0;this._init()};YjaxcStream.prototype={_init:function(){var a=this;window.yjaxclookup=function(c){var f=document.createElement("div");f.innerHTML=c[0];var b=f.childNodes.length;for(var d=0;d<b;d++){var e=f.childNodes[d];if(e.nodeType==1){a.adUnits.push(f.childNodes[d])}}};if(this.conf.dsName){this._fetch()}},_fetch:function(){var c="http://"+this.conf.oiHostName+"/oi?s="+this.conf.dsName+"&i=0&w=&apg=1&t=m&u="+encodeURIComponent(location.href)+"&ref="+encodeURIComponent(document.referrer)+"&enc="+(document.charset||document.characterSet).toUpperCase()+"&spaceId="+this._findSpaceId(document.body)+"&jisx0402=&type="+this.conf.typeTag+"&crawlUrl=&tagpos=&pv_ts="+getOrGenPVTS();var d=document.createElement("script");d.src=c;var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(d,a)},_findSpaceId:function(b){if(!b){return""}for(var a=0;a<b.childNodes.length;a++){var d=b.childNodes.item(a);switch(d.nodeType){case 1:var c=this._findSpaceId(d);if(c){return c}break;case 8:if(d.data.match(/SpaceID=([0-9]+)/)){return RegExp.$1}break;default:break}}return""},_findRequestId:function(c){var e=null;if(c.tagName.toLowerCase()=="a"){if(c.href.indexOf("http://rd.ane.yahoo.co.jp/rd?")==0){e=c.href}}if(!e){var b=c.getElementsByTagName("a");for(var d=0;d<b.length;d++){if(b[d].href.indexOf("http://rd.ane.yahoo.co.jp/rd?")==0){e=b[d].href;break}}}if(!e){return"unknown"}var a=e.match("RI=([a-zA-Z0-9]+)");if(a&&a.length==2){return a[1]}else{return"unknown"}},_sendTakenBeacon:function(b){var a=Math.random();var c=this.conf.vbeacon.entry+"?rs=stream_taken&v=1&rand="+a+"&ds="+this.conf.dsName+"&rid="+b+"&t="+this.takenCounter+"&EOQ";document.createElement("img").src=c},hasMoreAds:function(){return this.adUnits.length>0},takeAds:function(c){if(this.adUnits.length==0){c(null);return}var b=this.adUnits.shift();c(b);this.takenCounter++;var a=this._findRequestId(b);if(this.conf.vbeacon.enabled){this._sendTakenBeacon(a)}}};function getOrGenPVTS(){if(!window.yads_pv_timestamp){window.yads_pv_timestamp=parseInt(new Date().getTime())+"-"+Math.floor(Math.random()*10000000)}return window.yads_pv_timestamp}(function(){if(!window.yjaxc_stream_enable_actd){return}var e=navigator.userAgent.toLowerCase();if(e.indexOf("msie 6.")>=0||e.indexOf("msie 7.")>=0){return}var c="//b94.yahoo.co.jp/gb.gif";function d(m){var l=m.getBoundingClientRect();var h=document.body.scrollLeft||document.documentElement.scrollLeft;var j=document.body.scrollTop||document.documentElement.scrollTop;var o=Math.round(l.left+h);var k=Math.round(l.right+h);var n=Math.round(l.top+j);var i=Math.round(l.bottom+j);return{left:o,right:k,top:n,bottom:i}}function f(){var h=document.body.scrollLeft||document.documentElement.scrollLeft;var k=document.body.scrollTop||document.documentElement.scrollTop;var j=window.innerWidth||document.documentElement.clientWidth;var m=window.innerHeight||document.documentElement.clientHeight;var o=Math.round(h);var l=Math.round(j+h);var n=Math.round(k);var i=Math.round(m+k);return{left:o,right:l,top:n,bottom:i}}var b=function(){this.entry=c;this.detections=[];this.feedTypes="";this.sendNum=0};b.DEPTH=20;b.prototype={pushDetection:function(h){this.detections.push(h);if(this.detections.length>=b.DEPTH){this.send()}},pushFeedType:function(h){this.feedTypes+=h},send:function(l){var s=getOrGenPVTS();var p=Math.random();var o=window.yjaxc_stream_bucket_id||"";var j=l?"&ph=1":"";var r="",q="",k="";for(var h=0;h<this.detections.length;h++){var m=this.detections[h];q+="Y"+m.y+"S"+m.s+"E"+m.e+"N"+m.n+"C"+m.c+"V"+m.v;if(q==k){q="Z"}else{k=q}if(r.length>0){r+="!"}r+="T"+m.t+q;q=""}var n="?rs=stact&v=1&rand="+p+"&type="+encodeURIComponent(o)+"&pv="+encodeURIComponent(s)+"&c="+(++this.sendNum)+j+"&ft="+this.feedTypes+"&a="+encodeURIComponent(r)+"&EOQ";document.createElement("img").src=this.entry+n;this.detections=[];this.feedTypes=""},forceSend:function(h){this.send(!!h)}};var a=function(j){var h="none";if(window.getComputedStyle){var i=window.getComputedStyle(j,"");h=i.display}else{if(j.currentStyle){h=j.currentStyle.display}}if(h=="none"){this.isPending=true;return}this.position=d(j);this.isPending=false;this.e=j;this.feedType=this._detectFeedType()};a.prototype={isViewed:function(){var h=f();return((this.position.bottom>h.top)&&(this.position.top<h.bottom))},_detectFeedType:function(){var h=this.e.className;if(h.indexOf("feedArticle")>=0){if(h.indexOf("hasImg")==-1){return"1"}else{return"2"}}if(h.indexOf("feedBuzzWord")>=0){if(h.indexOf("hasImg")==-1){return"3"}else{return"4"}}if(h.indexOf("feedAd")>=0){return"5"}return"9"}};var g=function(){this.loadedAt=new Date().getTime();this.feedItems=[];this.sender=new b();this.lastDocHeight=-1;this.lastChecked=0;this.bfc=0;this.timerCheck=null;this.timerCollect=null;this._initEvents();this.collectFeeds()};g.COLLECT_INTERVAL=100;g.CHECK_INTERVAL=500;g.prototype={_initEvents:function(){var h=this;this.timerCollect=setInterval(function(){h.collectFeeds()},g.COLLECT_INTERVAL);this.timerCheck=setInterval(function(){h.check()},g.CHECK_INTERVAL);var l=[["scroll",function(){h.check()},false],["touchmove",function(){h.check()},false],["pageshow",function(i){h.handlePageshow(i)},false],["pagehide",function(i){h.handlePagehide(i)},false]];for(var j=0;j<l.length;j++){var k=l[j];if(window.addEventListener){window.addEventListener.apply(window,k)}else{if(window.attachEvent){window.attachEvent(k[0],k[1])}}}},_query:function(){if(document.querySelectorAll){var n=[];var l=document.querySelectorAll("li.feedArticle,li.feedBuzzWord,li.feedAd");for(var p=0;p<l.length;p++){n.push(l[p])}return n}var l=[];var k=document.getElementsByTagName("li");var q=["feedArticle","feedBuzzWord","feedAd"];for(var p=0;p<k.length;p++){var h=false;for(var o=0;o<q.length;o++){if(k[p]==q[o]){h=true;break}}if(h){l.push(k[p])}}return l},collectFeeds:function(){var l=(document.body.scrollHeight||document.documentElement.scrollHeight);if(this.feedItems.length>0&&l==this.lastDocHeight){return}this.lastDocHeight=l;var h=this._query();for(var j=this.feedItems.length;j<h.length;j++){var k=new a(h[j]);if(!k.isPending){this.feedItems.push(k);this.sender.pushFeedType(k.feedType)}}},_calcVRange:function(){var k=-1;var h=-1;for(var j=0;j<this.feedItems.length;j++){if(k==-1){if(this.feedItems[j].isViewed()){k=j+1}continue}if(!this.feedItems[j].isViewed()){h=j;break}}if(k!=-1&&h==-1){h=j}return[k,h]},_getVState:function(){var h=document.visibilityState||document.webkitVisibilityState||document.mozVisibilityState||document.msVisibilityState;var i="0";if(h=="prerender"){i="1"}if(h=="visible"){i="2"}if(h=="hidden"){i="3"}if(h=="unloaded"){i="4"}return i},check:function(l){var j=new Date().getTime();if(!l&&j-this.lastChecked<500){return}this.lastChecked=j;var k=f().top;var i=this._calcVRange();var n=this._getVState();var m=this.lastChecked-this.loadedAt;var h=Math.round(m/100);this.sender.pushDetection({t:h,y:k,s:i[0],e:i[1],n:this.feedItems.length,c:this.bfc,v:n})},handlePageshow:function(h){if(h.persisted){this.bfc++;this.check(true);this.sender.forceSend()}},handlePagehide:function(h){this.check(true);this.sender.forceSend(true)}};new g()})();